{% extends 'travel/baseIndex.html' %}

{% load static %}

{% load humanize %}

{% load currency_filters %}

{% block content %}
<main>
    <!-- Banner -->
    <section class="hero position-relative text-center">
        <img src="{% static 'images/banner.jpg' %}" class="hero-img">

        <!-- Thanh tìm kiếm 2 tầng -->
        <div
            class="search-box container-fluid rounded-4 shadow-lg p-4 border border-3 border-info position-absolute top-50 start-50 translate-middle bg-white">
            <!-- Thay thế xử lý search (code của Thanh) -->
            <!-- Tìm kiếm nhanh -->
            <div class="quick-search mb-4" style="overflow: visible;">
                <form method="GET" action="{% url 'travel:search' %}" class="position-relative" id="quickSearchForm"
                    style="overflow: visible;">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fa-solid fa-magnifying-glass text-primary"></i>
                        </span>
                        <input type="text" name="q" id="quickSearchInput" class="form-control border-start-0"
                            placeholder="Tìm kiếm địa điểm... (VD: Hà Nội, Chùa Một Cột, Hồ Hoàn Kiếm)"
                            autocomplete="off">
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fa-solid fa-search me-1"></i>Tìm
                        </button>
                    </div>
                    <div id="quickSuggestions" class="autocomplete-box"></div>
                </form>
            </div>

            <!-- CSS cho Autocomplete - Đơn giản và gọn gàng -->
            <style>
                .autocomplete-box {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid rgba(0, 0, 0, 0.08);
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                    max-height: 400px;
                    overflow-y: auto;
                    z-index: 9999;
                    display: none;
                    margin-top: 8px;
                    padding: 4px 0;
            </style>

            <!-- Tìm kiếm chi tiết -->
            <form class="row align-items-center gx-3 justify-content-center" method="GET"
                action="{% url 'travel:search' %}" id="detailSearchForm">
                <div class="col-md-3 position-relative" style="overflow: visible;">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fa-solid fa-location-dot text-primary"></i>
                        </span>
                        <input type="text" name="from_location" id="fromLocationInput" class="form-control"
                            placeholder="Vị trí của bạn" autocomplete="off">
                    </div>
                    <div id="fromLocationSuggestions" class="autocomplete-box"></div>
                </div>

                <div class="col-md-3 position-relative" style="overflow: visible;">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fa-solid fa-map-location-dot text-primary"></i>
                        </span>
                        <input type="text" name="q" id="toLocationInput" class="form-control" placeholder="Nơi muốn đến"
                            autocomplete="off">
                    </div>
                    <div id="toLocationSuggestions" class="autocomplete-box"></div>
                </div>

                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fa-solid fa-calendar-days text-primary"></i>
                        </span>
                        <input type="date" name="travel_date" id="travelDateInput" class="form-control">
                    </div>
                </div>

                <div class="col-md-3">
                    <button type="submit" class="btn btn-warning w-100 fw-bold py-2">
                        <i class="fa-solid fa-route me-1"></i>Tìm kiếm chi tiết
                    </button>
                </div>
            </form>

            <!-- Gợi ý nhanh -->
            <div class="quick-links mt-3 text-center">
                <small class="text-muted me-2">Địa điểm phổ biến:</small>
                <a href="{% url 'travel:search' %}?q=Hà Nội"
                    class="badge bg-light text-dark me-2 text-decoration-none py-2 px-3">Hà Nội</a>
                <a href="{% url 'travel:search' %}?q=TP Hồ Chí Minh"
                    class="badge bg-light text-dark me-2 text-decoration-none py-2 px-3">TP Hồ Chí Minh</a>
                <a href="{% url 'travel:search' %}?q=Đà Nẵng"
                    class="badge bg-light text-dark me-2 text-decoration-none py-2 px-3">Đà Nẵng</a>
                <a href="{% url 'travel:search' %}?q=Đà Lạt"
                    class="badge bg-light text-dark me-2 text-decoration-none py-2 px-3">Đà Lạt</a>
            </div>
        </div>

    </section>



    <!-- Code của Thanh -->
    <!-- Lịch sử tìm kiếm - Section riêng -->
    <section id="searchHistorySection" class="search-history-section py-3 d-none">
        <div class="container">
            <div class="search-history-card bg-white rounded-4 shadow-sm p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="fa-solid fa-clock-rotate-left text-primary me-2"></i>Tìm kiếm gần đây
                    </h5>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllHistory">
                        <i class="fa-solid fa-trash-can me-1"></i>Xóa tất cả
                    </button>
                </div>
                <div id="searchHistoryList" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>
    </section>

    <section id="categorySection" class="categories"
        style="background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);">
        <div class="container text-center py-5">
            <!-- Header hiện đại -->
            <div class="mb-5">
                <h3 class="fw-bold display-6 mb-2">Khám phá theo danh mục</h3>
                <p class="text-muted">Chọn loại hình du lịch phù hợp với bạn</p>
            </div>

            <div class="row g-4 justify-content-center">
                {% for cat in categories %}
                <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                    <a href="{% url 'travel:category_detail' slug=cat.slug %}" class="text-decoration-none">
                        <div class="card h-100 border-0 shadow-hover category-card-modern p-4"
                            style="border-radius: 16px; transition: all 0.3s ease; background: #fff;">
                            <div class="icon-wrapper mb-3 mx-auto d-flex align-items-center justify-content-center"
                                style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); transition: all 0.3s ease;">
                                <i class="fa-solid {{ cat.icon|default:'fa-map-marker-alt' }} fa-2x"
                                    style="color: #1976d2;"></i>
                            </div>
                            <p class="fw-semibold mb-0 text-dark" style="font-size: 0.9rem; line-height: 1.3;">
                                {{ cat.name }}
                            </p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- CSS cho category cards -->
    <style>
        .category-card-modern:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
        }

        .category-card-modern:hover .icon-wrapper {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%) !important;
            transform: scale(1.1);
        }

        .category-card-modern:hover .icon-wrapper i {
            color: #fff !important;
        }
    </style>


    <!-- Thêm phần đề xuất tour của Hạnh -->
    {% comment %} {% if recommendation %}
    <div id="recommendationsSection" class="recommendation-section mt-5">
        <h3 class="fw-bold mb-3">Đề xuất tour dành riêng cho bạn</h3>

        <div class="row g-4">
            {% for tour in recommendation %}
            <div class="col-lg-3 col-md-4 col-sm-6">
                <a href="{% url 'travel:tour_detail' tour_slug=tour.slug %}"
                    class="card tour-card shadow-sm border-0 rounded-xl overflow-hidden d-flex flex-column h-100">

                    <!-- ẢNH -->
                    <div class="image-wrapper">
                        {% if tour.image_main %}
                        <img src="{{ tour.image_main.url }}" class="img-fluid" alt="{{ tour.name }}">
                        {% else %}
                        <div class="placeholder-image">No Image</div>
                        {% endif %}
                    </div>

                    <!-- BODY -->
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold fs-6 mb-1 text-truncate text-gray-900">
                            {{ tour.name }}
                        </h5>

                        <!-- LOCATION -->
                        <p class="card-text text-muted small mb-2">
                            <i class="fa-solid fa-location-dot me-1"></i>
                            {{ tour.destination.location }}
                        </p>

                        <!-- RATING + TAG -->
                        <div class="d-flex align-items-center mb-2">
                            <i class="fa-solid fa-star text-amber-500 me-1 small"></i>
                            <span class="small fw-bold me-2 text-gray-700">
                                {{ tour.rating|floatformat:1|default:"0.0" }}
                            </span>

                            <span class="badge bg-light text-muted fw-normal">
                                {{ tour.destination.tags.all|join:", " }}
                            </span>
                        </div>

                        <!-- PRICE -->
                        {% if tour.price %}
                        <p class="fw-bold text-red-600 fs-5 mt-auto mb-0">
                            {{ tour.price|intcomma }}₫
                        </p>
                        {% else %}
                        <p class="fw-bold text-red-600 fs-5 mt-auto mb-0">Liên hệ để biết giá</p>
                        {% endif %}
                    </div>

                </a>
            </div>
            {% endfor %}
        </div>

    </div>
    {% endif %} {% endcomment %}

    <!-- Code của Thanh -->
    <!-- Gợi ý cá nhân hóa -->

    <section id="recommend-login-cta" class="py-5 bg-white text-center d-none">
        <div class="container">
            <i class="fa-solid fa-user-lock fa-3x text-primary mb-3"></i>
            <h4 class="fw-bold">Đăng nhập để xem gợi ý dành riêng cho bạn</h4>
            <p class="text-muted mb-4">
                Chúng tôi sẽ đề xuất địa điểm & tour phù hợp nhất với sở thích của bạn
            </p>

            <button class="btn btn-outline-primary btn-lg rounded-pill px-4" id="showLoginBtn" data-bs-toggle="modal"
                data-bs-target="#authModal">
                <i class="fa-solid fa-right-to-bracket me-2"></i>Đăng nhập ngay
            </button>
        </div>
    </section>

    <!--    {% if personalized_destinations or personalized_tours %}-->
    <section class="recommend py-5 bg-white d-none" id="personalized-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold mb-2">
                    <i class="fa-solid fa-wand-magic-sparkles text-primary me-2"></i>Dành riêng cho {% if request.user.is_authenticated %}{{ request.user.username }}{% else %}bạn{% endif %}
                </h2>
                <p class="text-muted">Hệ thống AI đã phân tích sở thích để đưa ra những gợi ý phù hợp nhất</p>
            </div>

            {% if personalized_destinations %}
            <div class="mb-5">
                <h4 class="fw-bold mb-4"><i class="fa-solid fa-map-location-dot text-primary me-2"></i>Địa điểm bạn sẽ
                    thích</h4>
                <div class="row g-4">
                    {% for dest in personalized_destinations %}
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm border-0 position-relative card-hover"
                            style="border-radius: 15px; overflow: hidden;">
                            <span class="badge bg-primary position-absolute top-0 end-0 m-3 shadow-sm">
                                <i class="fa-solid fa-heart"></i> Gợi ý AI
                            </span>

                            {% with db_img=dest.images.all.first %}
                            {% if db_img %}
                            <img src="{{ db_img.image.url }}" class="card-img-top" alt="{{ dest.name }}"
                                style="height: 220px; object-fit: cover;">
                            {% elif dest.image %}
                            <img src="{{ dest.image.url }}" class="card-img-top" alt="{{ dest.name }}"
                                style="height: 220px; object-fit: cover;">
                            {% else %}
                            <img src="{% static 'images/'|add:dest.slug|add:'/'|add:dest.slug|add:'.jpg' %}"
                                class="card-img-top" style="height: 220px; object-fit: cover;"
                                onerror="this.src='{% static 'images/default-destination.jpg' %}';">
                            {% endif %}
                            {% endwith %}

                            <div class="card-body">
                                <h5 class="card-title fw-bold mb-1">{{ dest.name }}</h5>
                                <p class="text-muted small mb-3"><i class="fa-solid fa-location-dot"></i> {{ dest.location }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-warning small">
                                        <i class="fa-solid fa-star"></i> {{ dest.avg_rating|default:"5.0" }}
                                    </div>
                                    <a href="{% url 'travel:destination_detail' dest.id %}"
                                        class="btn btn-primary btn-sm px-4 rounded-pill">Khám phá</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <hr class="my-5 opacity-25">

            {% if personalized_tours %}
            <div>
                <h4 class="fw-bold mb-4"><i class="fa-solid fa-suitcase-rolling text-danger me-2"></i>Tour dành cho bạn
                </h4>
                <div class="row g-4">
                    {% for tour in personalized_tours %}
                    <div class="col-lg-6">
                        <div class="card h-100 shadow-sm border-0 bg-light card-hover"
                            style="border-radius: 12px; transition: transform 0.3s;">
                            <div class="row g-0 h-100">
                                <div class="col-4 p-2">
                                    {% if tour.image_main %}
                                    <img src="{{ tour.image_main.url }}" class="img-fluid rounded h-100"
                                        style="object-fit: cover; min-height: 120px;">
                                    {% else %}
                                    {% with t_dest_img=tour.destination.images.all.first %}
                                    {% if t_dest_img %}
                                    <img src="{{ t_dest_img.image.url }}" class="img-fluid rounded h-100"
                                        style="object-fit: cover; min-height: 120px;">
                                    {% else %}
                                    <img src="{% static 'images/'|add:tour.destination.slug|add:'/'|add:tour.destination.slug|add:'.jpg' %}"
                                        class="img-fluid rounded h-100" style="object-fit: cover; min-height: 120px;"
                                        onerror="this.src='{% static 'images/default-tour.jpg' %}';">
                                    {% endif %}
                                    {% endwith %}
                                    {% endif %}
                                </div>
                                <div class="col-8">
                                    <div class="card-body d-flex flex-column h-100">
                                        <h6 class="fw-bold mb-1 text-truncate-2">{{ tour.name }}</h6>
                                        <div class="small text-muted mb-2">
                                            <i class="fa-solid fa-calendar-day me-1"></i> Khởi hành hàng ngày
                                        </div>
                                        <div class="mt-auto d-flex justify-content-between align-items-end">
                                            <div>
                                                <span class="text-danger fw-bold fs-5">{{ tour.price|floatformat:0|intcomma }}</span>
                                                <small class="text-muted">VND</small>
                                            </div>
                                            <a href="{% url 'travel:tour_detail' tour.slug %}"
                                                class="btn btn-outline-danger btn-sm rounded-pill px-3">Chi tiết</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </section>
    <!--    {% endif %}-->

    <hr class="container m-0">

    {% if top_destinations %}
    <section class="recommend py-5" id="recommend-section"
        style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <div class="container">
            <!-- Header hiện đại -->
            <div class="text-center mb-5">
                <h2 class="fw-bold display-6 mb-2">Địa điểm nổi bật</h2>
                <p class="text-muted lead">Xếp hạng dựa trên trải nghiệm cộng đồng và phân tích AI</p>
            </div>

            <div class="row g-4">
                {% for dest in top_destinations %}
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100 border-0 shadow-hover destination-card"
                        style="border-radius: 16px; overflow: hidden; transition: all 0.3s ease;">
                        <div class="position-relative overflow-hidden">
                            {% if dest.image %}
                            <img src="{{ dest.image.url }}" class="card-img-top dest-img" alt="{{ dest.name }}"
                                style="height: 240px; object-fit: cover; transition: transform 0.4s ease;">
                            {% elif dest.images.all.first %}
                            <img src="{{ dest.images.all.first.image.url }}" class="card-img-top dest-img"
                                alt="{{ dest.name }}"
                                style="height: 240px; object-fit: cover; transition: transform 0.4s ease;">
                            {% else %}
                            <img src="https://via.placeholder.com/400x250?text=No+Image+Found"
                                class="card-img-top dest-img"
                                style="height: 240px; object-fit: cover; transition: transform 0.4s ease;">
                            {% endif %}

                            <!-- Overlay gradient -->
                            <div class="position-absolute bottom-0 start-0 end-0"
                                style="height: 80px; background: linear-gradient(transparent, rgba(0,0,0,0.6));"></div>

                            <!-- AI Score badge - Click để xem chi tiết -->
                            <span class="badge position-absolute top-0 end-0 m-3 shadow ai-score-badge"
                                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); font-size: 0.8rem; padding: 8px 12px; cursor: pointer;"
                                data-bs-toggle="modal" data-bs-target="#aiScoreModal" data-dest-name="{{ dest.name }}"
                                data-dest-id="{{ dest.id }}"
                                data-overall-score="{{ dest.recommendation.overall_score|floatformat:0|default:'0' }}"
                                data-avg-rating="{{ dest.avg_rating|floatformat:1|default:'0' }}"
                                data-total-reviews="{{ dest.recommendation.total_reviews|default:'0' }}"
                                data-positive-ratio="{{ dest.recommendation.positive_review_ratio|floatformat:0|default:'0' }}"
                                data-sentiment-score="{{ dest.recommendation.sentiment_score|floatformat:0|default:'0' }}"
                                title="Click để xem chi tiết phân tích AI">
                                <i class="fa-solid fa-robot me-1"></i>AI Score:
                                {{ dest.recommendation.overall_score|floatformat:0|default:"90" }}
                            </span>

                            <!-- Location overlay -->
                            <div class="position-absolute bottom-0 start-0 m-3 text-white">
                                <small><i class="fa-solid fa-location-dot me-1"></i>{{ dest.location }}</small>
                            </div>
                        </div>

                        <div class="card-body p-4">
                            <h5 class="card-title fw-bold mb-2 dest-title" style="color: #2d3748;">{{ dest.name }}</h5>
                            <p class="card-text small text-secondary mb-3"
                                style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                {{ dest.description|truncatechars:100 }}
                            </p>

                            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-info-subtle text-info me-2">
                                        <i class="fa-solid fa-route me-1"></i>{{ dest.num_tours|default:"0" }} Tours
                                    </span>
                                    <div class="text-warning">
                                        <i class="fa-solid fa-star" style="font-size: 0.8rem;"></i>
                                        <small class="text-dark fw-bold ms-1">
                                            {{ dest.avg_rating|floatformat:1|default:"4.5" }}
                                        </small>
                                    </div>
                                </div>
                                <a href="{% url 'travel:destination_detail' dest.id %}"
                                    class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                    Khám phá <i class="fa-solid fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- CSS cho destination cards -->
    <style>
        .destination-card {
            background: #fff;
        }

        .destination-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12) !important;
        }

        .destination-card:hover .dest-img {
            transform: scale(1.08);
        }

        .dest-title {
            transition: color 0.3s ease;
        }

        .destination-card:hover .dest-title {
            color: #0d6efd !important;
        }
    </style>
    {% endif %}

    <!-- TRENDING SECTION -->
    <section class="trending-section py-5 bg-light">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">
                        <i class="fa-solid fa-fire text-danger me-2"></i>Xu hướng tìm kiếm
                    </h3>
                    <p class="text-muted small mb-0">Các địa điểm hot nhất trong 7 ngày qua</p>
                </div>
            </div>

            <div class="row g-3">
                {% for dest in trending_destinations %}
                <div class="col-6 col-md-3">
                    <a href="{% url 'travel:destination_detail' dest.id %}" class="text-decoration-none">
                        <div class="card h-100 border-0 shadow-sm trending-card overflow-hidden">
                            <div class="position-relative">
                                {% if dest.images.all.first %}
                                <img src="{{ dest.images.all.first.image.url }}" class="card-img-top"
                                    alt="{{ dest.name }}" style="height: 140px; object-fit: cover;">
                                {% else %}
                                <img src="{% static 'images/default-destination.jpg' %}" class="card-img-top"
                                    alt="{{ dest.name }}" style="height: 140px; object-fit: cover;">
                                {% endif %}
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge bg-danger shadow-sm">
                                        #{{ forloop.counter }} Trending
                                    </span>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <h6 class="card-title fw-bold text-dark mb-1 text-truncate">{{ dest.name }}</h6>
                                <p class="card-text text-muted small mb-2 text-truncate">
                                    <i class="fa-solid fa-location-dot me-1"></i>{{ dest.location }}
                                </p>
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="small text-warning fw-bold">
                                        <i class="fa-solid fa-star"></i> {{ dest.rating|default:"4.5" }}
                                    </div>
                                    <small class="text-primary fw-bold">
                                        {{ dest.recommendation.overall_score|floatformat:0 }} điểm AI
                                    </small>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% empty %}
                <div class="col-12 text-center text-muted py-4">
                    Đang cập nhật dữ liệu xu hướng...
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- CSS cho Trending Section -->
    <style>
        .trending-card {
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .trending-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
        }

        .trending-card .badge {
            font-size: 0.7rem;
            backdrop-filter: blur(4px);
            background: rgba(220, 53, 69, 0.9) !important;
        }
    </style>

    <section class="featured-tours py-5 bg-white">
        <div class="container">
            <!-- Header section với thiết kế hiện đại -->
            <div class="text-center mb-5">
                <h2 class="fw-bold display-6 mb-2">{{ category_name|default:"Hành trình hấp dẫn" }}</h2>
                <p class="text-muted lead">Khám phá những tour du lịch được yêu thích nhất</p>
            </div>

            <!-- Grid tour cards với thiết kế hiện đại -->
            <div class="row g-4">
                {% for tour in featured_tours %}
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card h-100 border-0 shadow-hover tour-card"
                        style="border-radius: 16px; overflow: hidden; transition: all 0.3s ease;">
                        <!-- Image container -->
                        <div class="position-relative overflow-hidden">
                            {% if tour.image_main %}
                            <img src="{{ tour.image_main.url }}" class="card-img-top tour-img" alt="{{ tour.name }}"
                                style="height: 200px; object-fit: cover; transition: transform 0.4s ease;">
                            {% else %}
                            <img src="{% static 'images/default-tour.jpg' %}" class="card-img-top tour-img"
                                alt="{{ tour.name }}"
                                style="height: 200px; object-fit: cover; transition: transform 0.4s ease;">
                            {% endif %}

                            <!-- Overlay gradient -->
                            <div class="position-absolute bottom-0 start-0 end-0"
                                style="height: 60px; background: linear-gradient(transparent, rgba(0,0,0,0.5));"></div>

                            <!-- Category badge -->
                            <div class="position-absolute top-0 start-0 m-3">
                                <span class="badge text-white shadow-sm"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem;">
                                    {{ tour.category.name }}
                                </span>
                            </div>

                            <!-- Favorite button -->
                            <div class="position-absolute top-0 end-0 m-3">
                                <button class="btn btn-sm btn-light rounded-circle shadow-sm favorite-btn p-2"
                                    data-url="{% url 'travel:toggle_tour_favorite' tour.id %}"
                                    data-auth="{{ request.user.is_authenticated|yesno:'1,0' }}">
                                    <i class="
                                        {% if request.user.is_authenticated and request.user in tour.favorited_by.all %}
                                            fa-solid
                                        {% else %}
                                            fa-regular
                                        {% endif %}
                                        fa-heart text-danger"></i>
                                </button>
                            </div>

                            <!-- Duration badge -->
                            <div class="position-absolute bottom-0 end-0 m-3">
                                <span class="badge bg-dark bg-opacity-75 text-white">
                                    <i class="fa-regular fa-clock me-1"></i>{{ tour.duration }} ngày
                                </span>
                            </div>
                        </div>

                        <!-- Card body -->
                        <div class="card-body p-3">
                            <!-- Location -->
                            <div class="d-flex align-items-center mb-2">
                                <i class="fa-solid fa-location-dot text-primary me-2" style="font-size: 0.8rem;"></i>
                                <small class="text-muted">{{ tour.destination.name }}</small>
                            </div>

                            <!-- Title -->
                            <h6 class="card-title fw-bold mb-2 tour-title"
                                style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 2.8rem; line-height: 1.4;">
                                {{ tour.name }}
                            </h6>

                            <!-- Rating -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="text-warning me-2">
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= tour.average_rating %} <i class="fa-solid fa-star"
                                        style="font-size: 0.75rem;"></i>
                                        {% else %}
                                        <i class="fa-regular fa-star" style="font-size: 0.75rem;"></i>
                                        {% endif %}
                                        {% endfor %}
                                </div>
                                <small class="text-muted">({{ tour.total_reviews }} đánh giá)</small>
                            </div>

                            <!-- Price and CTA -->
                            <div class="d-flex justify-content-between align-items-end pt-2 border-top">
                                <div>
                                    <small class="text-muted d-block">Giá từ</small>
                                    <span class="text-danger fw-bold" style="font-size: 1.1rem;">
                                        {% if tour.price %}
                                        {{ tour.price|floatformat:0|intcomma }}đ
                                        {% else %}
                                        Liên hệ
                                        {% endif %}
                                    </span>
                                </div>
                                <a href="{% url 'travel:tour_detail' tour.slug %}"
                                    class="btn btn-primary btn-sm rounded-pill px-3">
                                    <i class="fa-solid fa-arrow-right me-1"></i>Chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="py-5">
                        <i class="fa-solid fa-suitcase-rolling fa-4x text-muted mb-3 opacity-50"></i>
                        <p class="text-muted fs-5">Hiện chưa có tour nào trong mục này.</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Nút xem tất cả ở dưới với màu xanh -->
            <div class="text-center mt-5">
                <a href="{% url 'travel:all_tours' %}" class="btn btn-primary btn-lg px-5 py-3 rounded-pill shadow-sm"
                    style="background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%); border: none; font-weight: 600;">
                    <i class="fa-solid fa-th-large me-2"></i>Xem tất cả tour
                    <i class="fa-solid fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- CSS cho phần tour -->
    <style>
        .tour-card {
            background: #fff;
        }

        .tour-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12) !important;
        }

        .tour-card:hover .tour-img {
            transform: scale(1.08);
        }

        .tour-title {
            color: #2d3748;
            transition: color 0.3s ease;
        }

        .tour-card:hover .tour-title {
            color: #0d6efd;
        }

        .shadow-hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .favorite-btn {
            transition: all 0.3s ease;
            opacity: 0.9;
        }

        .favorite-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .badge {
            font-weight: 500;
        }
    </style>


    <section class="recommend py-5">
        <div class="container-fluid text-center">
            <h2 class="fw-bold mb-3">Dải Đất Hình Chữ S</h2>
            <p class="text-muted mb-4">Khám phá Việt Nam theo cách riêng của bạn</p>
            <div class="row justify-content-center g-4">
                {% for r in results %}
                <div class="col-md-3">
                    <div class="card shadow-lg border-0 rounded-3 position-relative overflow-hidden">
                        <div class="image-wrapper">
                            <img src="{% static 'images/' %}{{ r.images.0 }}" class="card-img-top" alt="{{ r.name }}">

                            <div class="image-overlay">
                                <div class="slideshow">
                                    {% for img in r.images %}
                                    <img src="{% static 'images/' %}{{ img }}"
                                        class="slide {% if forloop.first %}active{% endif %}">
                                    {% endfor %}
                                    <button class="prev">&#10094;</button>
                                    <button class="next">&#10095;</button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body text-center">
                            <h5 class="card-title fw-bold text-primary">{{ r.name }}</h5>
                            <p class="card-text text-muted">{{ r.desc }}</p>
                            <button class="btn btn-outline-primary explore-btn mt-2 rounded-pill">Khám phá ngay</button>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </div>
        </div>
    </section>
</main>

{% comment %}
<!-- DISABLED: Using index.js displayQuickSuggestions() instead -->
<script>
    // ==================== AUTOCOMPLETE CHO THANH TÌM KIẾM ====================
    class DestinationAutocomplete {
        constructor(inputId, suggestionsId, options = {}) {
            this.input = document.getElementById(inputId);
            this.suggestionsBox = document.getElementById(suggestionsId);
            this.debounceTimer = null;
            this.minChars = options.minChars || 1;
            this.debounceDelay = options.debounceDelay || 300;
            this.apiUrl = options.apiUrl || '/api/search/';

            if (this.input && this.suggestionsBox) {
                this.init();
            }
        }

        init() {
            // Xử lý input
            this.input.addEventListener('input', (e) => this.handleInput(e));

            // Xử lý focus
            this.input.addEventListener('focus', () => {
                if (this.input.value.length >= this.minChars) {
                    this.search(this.input.value);
                }
            });

            // Đóng suggestions khi click ra ngoài
            document.addEventListener('click', (e) => {
                if (!this.input.contains(e.target) && !this.suggestionsBox.contains(e.target)) {
                    this.hideSuggestions();
                }
            });

            // Xử lý keyboard navigation
            this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        }

        handleInput(e) {
            const query = e.target.value.trim();

            // Clear timer cũ
            if (this.debounceTimer) {
                clearTimeout(this.debounceTimer);
            }

            if (query.length < this.minChars) {
                this.hideSuggestions();
                return;
            }

            // Debounce để tránh gọi API quá nhiều
            this.debounceTimer = setTimeout(() => {
                this.search(query);
            }, this.debounceDelay);
        }

        async search(query) {
            this.showLoading();

            try {
                const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                // Map API response to expected format
                const combined = {
                    destinations: data.results || [], // API returns 'results' for destinations
                    tours: data.tours || []
                };

                if (combined.destinations.length > 0 || combined.tours.length > 0) {
                    this.renderSuggestions(combined, query);
                } else {
                    this.showEmpty(query);
                }
            } catch (error) {
                console.error('Search error:', error);
                this.showEmpty(query);
            }
        }

        renderSuggestions(results, query) {
            this.suggestionsBox.innerHTML = '';

            // Combine destinations and tours for rendering
            // We can add a 'type' property to distinguish if needed, but the object structure differs slightly

            // 1. Render Destinations
            if (results.destinations && results.destinations.length > 0) {
                // Header cho Destinations (Optional)
                // const destHeader = document.createElement('div');
                // destHeader.className = 'suggestion-section-header px-3 py-1 text-muted small fw-bold bg-light';
                // destHeader.innerText = 'ĐỊA ĐIỂM';
                // this.suggestionsBox.appendChild(destHeader);

                results.destinations.forEach((dest, index) => {
                    const item = this.createSuggestionItem(dest, query, 'destination');
                    this.suggestionsBox.appendChild(item);
                });
            }

            // 2. Render Tours
            if (results.tours && results.tours.length > 0) {
                // Header cho Tours
                // const tourHeader = document.createElement('div');
                // tourHeader.className = 'suggestion-section-header px-3 py-1 text-muted small fw-bold bg-light';
                // tourHeader.innerText = 'TOURS';
                // this.suggestionsBox.appendChild(tourHeader);

                results.tours.forEach((tour, index) => {
                    const item = this.createSuggestionItem(tour, query, 'tour');
                    this.suggestionsBox.appendChild(item);
                });
            }

            this.showSuggestions();
        }

        createSuggestionItem(data, query, type) {
            const item = document.createElement('div');
            item.className = 'custom-autocomplete-item';

            // Highlight text khớp
            const highlightedName = this.highlightMatch(data.name, query);
            const locationText = type === 'tour' ? data.destination : data.location;
            const highlightedLocation = this.highlightMatch(locationText, query);

            let icon = type === 'tour' ? '<i class="fa-solid fa-flag text-danger"></i>' : '<i class="fa-solid fa-map-marker-alt text-primary"></i>';
            let subIcon = '<i class="fa-solid fa-location-dot"></i>';

            // Price for tours
            let priceHtml = '';
            if (type === 'tour' && data.price) {
                const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.price);
                priceHtml = `<span class="suggestion-price text-danger fw-bold ms-auto" style="font-size: 0.85rem;">${formattedPrice}</span>`;
            }

            item.innerHTML = `
                <div class="suggestion-header-row justify-content-between">
                    <div class="d-flex align-items-center gap-2" style="overflow: hidden;">
                        ${icon}
                        <span class="suggestion-title text-truncate">${highlightedName}</span>
                    </div>
                </div>
                <div class="suggestion-sub d-flex justify-content-between w-100">
                    <div class="d-flex align-items-center gap-1 text-truncate">
                        ${subIcon}
                        <span>${highlightedLocation}</span>
                    </div>
                    ${data.avg_rating ? `<span class="suggestion-rating ms-2"><i class="fa-solid fa-star"></i> ${data.avg_rating}</span>` : ''}
                </div>
                ${priceHtml ? `<div class="text-end w-100 mt-1">${priceHtml}</div>` : ''}
            `;

            // Click để chọn
            item.addEventListener('click', () => {
                if (type === 'tour' && data.slug) {
                    window.location.href = `/tour/${data.slug}/`; // Chuyển hướng trực tiếp đến tour
                } else {
                    this.selectDestination(data);
                }
            });

            return item;
        }

        highlightMatch(text, query) {
            if (!text || !query) return text || '';
            const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        selectDestination(dest) {
            this.input.value = dest.name;
            this.hideSuggestions();

            // Tự động submit form hoặc chuyển đến trang chi tiết
            const form = this.input.closest('form');
            if (form) {
                form.submit();
            }
        }

        handleKeydown(e) {
            const items = this.suggestionsBox.querySelectorAll('.custom-autocomplete-item');
            const activeItem = this.suggestionsBox.querySelector('.custom-autocomplete-item.active');
            let currentIndex = activeItem ? parseInt(activeItem.dataset.index) : -1;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    this.setActiveItem(items, currentIndex);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, 0);
                    this.setActiveItem(items, currentIndex);
                    break;
                case 'Enter':
                    if (activeItem) {
                        e.preventDefault();
                        activeItem.click();
                    }
                    break;
                case 'Escape':
                    this.hideSuggestions();
                    break;
            }
        }

        setActiveItem(items, index) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        showLoading() {
            this.suggestionsBox.innerHTML = `
            <div class="autocomplete-loading">
                <i class="fa-solid fa-spinner fa-spin me-2"></i>Đang tìm kiếm...
            </div>
        `;
            this.showSuggestions();
        }

        showEmpty(query) {
            this.suggestionsBox.innerHTML = `
            <div class="autocomplete-empty">
                <i class="fa-solid fa-search me-2"></i>Không tìm thấy "${query}"
            </div>
        `;
            this.showSuggestions();
        }

        showSuggestions() {
            this.suggestionsBox.classList.add('show');
        }

        hideSuggestions() {
            this.suggestionsBox.classList.remove('show');
        }
    }

    // Khởi tạo autocomplete cho các input
    document.addEventListener('DOMContentLoaded', function () {
        // Autocomplete cho thanh tìm kiếm nhanh
        new DestinationAutocomplete('quickSearchInput', 'quickSuggestions', {
            minChars: 1,
            debounceDelay: 250
        });

        // Autocomplete cho input "Nơi muốn đến"
        new DestinationAutocomplete('toLocationInput', 'toLocationSuggestions', {
            minChars: 1,
            debounceDelay: 250
        });

        // Autocomplete cho input "Vị trí của bạn" (dùng API provinces)
        const fromLocationInput = document.getElementById('fromLocationInput');
        const fromLocationSuggestions = document.getElementById('fromLocationSuggestions');

        if (fromLocationInput && fromLocationSuggestions) {
            let debounceTimer = null;

            fromLocationInput.addEventListener('input', function () {
                const query = this.value.trim();

                if (debounceTimer) clearTimeout(debounceTimer);

                if (query.length < 1) {
                    fromLocationSuggestions.classList.remove('show');
                    return;
                }

                debounceTimer = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/provinces/?q=${encodeURIComponent(query)}`);
                        const data = await response.json();

                        if (data.provinces && data.provinces.length > 0) {
                            fromLocationSuggestions.innerHTML = data.provinces.map(p => `
                            <div class="custom-autocomplete-item" data-value="${p}">
                                <i class="fa-solid fa-location-dot me-2 text-primary"></i>${p}
                            </div>
                        `).join('');

                            fromLocationSuggestions.querySelectorAll('.custom-autocomplete-item').forEach(item => {
                                item.addEventListener('click', function () {
                                    fromLocationInput.value = this.dataset.value;
                                    fromLocationSuggestions.classList.remove('show');
                                });
                            });

                            fromLocationSuggestions.classList.add('show');
                        } else {
                            fromLocationSuggestions.innerHTML = `
                            <div class="autocomplete-empty">Không tìm thấy địa điểm</div>
                        `;
                            fromLocationSuggestions.classList.add('show');
                        }
                    } catch (error) {
                        console.error('Province search error:', error);
                    }
                }, 250);
            });

            document.addEventListener('click', (e) => {
                if (!fromLocationInput.contains(e.target) && !fromLocationSuggestions.contains(e.target)) {
                    fromLocationSuggestions.classList.remove('show');
                }
            });
        }
    });
</script>
{% endcomment %}

<!-- // Xử lý nút "Khám phá ngay" - CHỈ cho các card trong section "Dải Đất Hình Chữ S" -->
<script>
    document.querySelectorAll(".recommend .card:not(.destination-card) .btn-outline-primary").forEach((btn) => {
        // Chỉ áp dụng cho các card KHÔNG phải destination-card (tức là card ảnh static)
        btn.addEventListener("click", (e) => {
            // Bỏ qua nếu nút có href thực sự (link đến trang khác)
            if (btn.tagName === 'A' && btn.getAttribute('href') && btn.getAttribute('href') !== '#') {
                return; // Cho phép link hoạt động bình thường
            }

            e.preventDefault();
            const card = e.target.closest(".card");
            if (!card) return;

            const title = card.querySelector(".card-title")?.textContent || '';
            const desc = card.querySelector(".card-text")?.textContent || '';
            const imgSrc = card.querySelector("img")?.src || '';

            // Tạo modal tạm thời
            const modal = document.createElement("div");
            modal.classList.add("explore-modal");
            modal.innerHTML = `
    <div class="modal-content">
        <div class="close-icon"><i class="fa-solid fa-xmark"></i></div>
        <img src="${imgSrc}" alt="${title}">
        <h3>${title}</h3>
        <p>${desc}</p>
        <button class="close-btn">Đóng</button>
    </div>
    `;

            document.body.appendChild(modal);

            // Đóng modal
            modal.querySelector(".close-btn").addEventListener("click", () => {
                modal.remove();
            });
            modal.querySelector(".close-icon").addEventListener("click", () => {
                modal.remove();
            });

        });
    });
</script>

<!-- ===== SLIDESHOW ===== -->
<script>
    document.querySelectorAll('.image-wrapper').forEach(wrapper => {
        const slides = wrapper.querySelectorAll('.slide');
        const prevBtn = wrapper.querySelector('.prev');
        const nextBtn = wrapper.querySelector('.next');
        let index = 0;
        let interval;

        function showSlide(n) {
            if (slides.length === 0) return;
            slides.forEach(s => s.classList.remove('active'));
            slides[n].classList.add('active');
        }

        // Tự động chạy khi hover
        wrapper.addEventListener('mouseenter', () => {
            if (slides.length <= 1) return; // Không chạy nếu chỉ có 1 ảnh
            interval = setInterval(() => {
                index = (index + 1) % slides.length;
                showSlide(index);
            }, 3000); // 3 giây chuyển 1 lần
        });

        // Dừng và quay về ảnh đầu khi rời chuột
        wrapper.addEventListener('mouseleave', () => {
            clearInterval(interval);
            index = 0;
            showSlide(index);
        });

        // Nút bấm thủ công
        if (prevBtn && nextBtn) {
            prevBtn.addEventListener('click', (e) => {
                e.preventDefault(); // Chặn chuyển trang nếu nằm trong thẻ <a>
                index = (index - 1 + slides.length) % slides.length;
                showSlide(index);
            });

            nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                index = (index + 1) % slides.length;
                showSlide(index);
            });
        }
    });
</script>

<!-- Nút trở lên đầu trang -->
<button id="btnTop" class="btn-top">
    <i class="bi bi-arrow-up"></i>
</button>

<script>
    const btnTop = document.getElementById("btnTop");

    window.addEventListener("scroll", () => {
        if (window.scrollY > 50) {
            btnTop.classList.add("show");
        } else {
            btnTop.classList.remove("show");
        }
    });

    btnTop.addEventListener("click", () => {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    });
</script>

<!-- Modal AI Score Chi tiết -->
<div class="modal fade" id="aiScoreModal" tabindex="-1" aria-labelledby="aiScoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0 pb-0"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="modal-title text-white" id="aiScoreModalLabel">
                    <i class="fa-solid fa-robot me-2"></i>Phân tích AI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <h5 class="fw-bold mb-4" id="modalDestName">Tên địa điểm</h5>

                <!-- Overall Score -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold"><i class="fa-solid fa-chart-line text-primary me-2"></i>Điểm tổng
                            hợp</span>
                        <span class="badge bg-success fs-5" id="modalOverallScore">0</span>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 5px;">
                        <div class="progress-bar bg-success" id="modalOverallProgress" role="progressbar"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Sentiment Score -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold"><i class="fa-solid fa-face-smile text-warning me-2"></i>Điểm cảm
                            xúc</span>
                        <span class="badge bg-warning text-dark" id="modalSentimentScore">0</span>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar bg-warning" id="modalSentimentProgress" role="progressbar"
                            style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Phân tích từ nội dung đánh giá</small>
                </div>

                <!-- Rating -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold"><i class="fa-solid fa-star text-warning me-2"></i>Đánh giá trung
                            bình</span>
                        <span id="modalAvgRating">0</span>/5.0
                    </div>
                    <div class="text-warning" id="modalStars">
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                    </div>
                </div>

                <!-- Stats -->
                <div class="row g-3">
                    <div class="col-6">
                        <div class="bg-light rounded-3 p-3 text-center">
                            <i class="fa-solid fa-comments text-info fs-4 mb-2"></i>
                            <div class="fw-bold" id="modalTotalReviews">0</div>
                            <small class="text-muted">Đánh giá</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-light rounded-3 p-3 text-center">
                            <i class="fa-solid fa-heart text-danger fs-4 mb-2"></i>
                            <div class="fw-bold"><span id="modalPositiveRatio">0</span>%</div>
                            <small class="text-muted">Yêu thích</small>
                        </div>
                    </div>
                </div>

                <!-- Explanation -->
                <div class="alert alert-info mt-4 mb-0" style="border-radius: 12px;">
                    <i class="fa-solid fa-lightbulb me-2"></i>
                    <strong>AI Score</strong> được tính dựa trên: đánh giá sao, phân tích cảm xúc từ nội dung review, độ
                    phổ biến, và mức độ tương tác của người dùng.
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <a href="#" id="modalViewDetail" class="btn btn-primary rounded-pill px-4">
                    <i class="fa-solid fa-arrow-right me-1"></i>Xem chi tiết địa điểm
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Xử lý click vào AI Score badge - Đợi DOM load xong
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.ai-score-badge').forEach(badge => {
            badge.addEventListener('click', function (e) {
                e.stopPropagation(); // Ngăn event bubble lên card

                const destName = this.dataset.destName || 'Không xác định';
                const destId = this.dataset.destId || '';
                const overallScore = parseFloat(this.dataset.overallScore) || 0;
                const avgRating = parseFloat(this.dataset.avgRating) || 0;
                const totalReviews = this.dataset.totalReviews || '0';
                const positiveRatio = this.dataset.positiveRatio || '0';
                const sentimentScore = parseFloat(this.dataset.sentimentScore) || 0;

                console.log('AI Score clicked:', { destName, destId, overallScore, avgRating, totalReviews, positiveRatio, sentimentScore });

                // Cập nhật modal
                const modalDestName = document.getElementById('modalDestName');
                const modalOverallScore = document.getElementById('modalOverallScore');
                const modalOverallProgress = document.getElementById('modalOverallProgress');
                const modalSentimentScore = document.getElementById('modalSentimentScore');
                const modalSentimentProgress = document.getElementById('modalSentimentProgress');
                const modalAvgRating = document.getElementById('modalAvgRating');
                const modalTotalReviews = document.getElementById('modalTotalReviews');
                const modalPositiveRatio = document.getElementById('modalPositiveRatio');
                const modalStars = document.getElementById('modalStars');
                const modalViewDetail = document.getElementById('modalViewDetail');

                if (modalDestName) modalDestName.textContent = destName;
                if (modalOverallScore) modalOverallScore.textContent = overallScore + '/100';
                if (modalOverallProgress) modalOverallProgress.style.width = overallScore + '%';
                if (modalSentimentScore) modalSentimentScore.textContent = sentimentScore + '/100';
                if (modalSentimentProgress) modalSentimentProgress.style.width = sentimentScore + '%';
                if (modalAvgRating) modalAvgRating.textContent = avgRating.toFixed(1);
                if (modalTotalReviews) modalTotalReviews.textContent = totalReviews;
                if (modalPositiveRatio) modalPositiveRatio.textContent = positiveRatio;

                // Cập nhật stars
                if (modalStars) {
                    let starsHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= Math.round(avgRating)) {
                            starsHtml += '<i class="fa-solid fa-star"></i> ';
                        } else {
                            starsHtml += '<i class="fa-regular fa-star"></i> ';
                        }
                    }
                    modalStars.innerHTML = starsHtml;
                }

                // Cập nhật link xem chi tiết
                if (modalViewDetail && destId) {
                    modalViewDetail.href = '/destination/' + destId + '/';
                }
            });
        });
    });
</script>

<!--&lt;!&ndash; JS custom &ndash;&gt;-->
<!--<script src="{% static 'js/index.js' %}"></script>-->

<!--&lt;!&ndash; JS custom &ndash;&gt;-->
<!--<script src="{% static 'js/index.js' %}"></script>-->

<!-- js cho button tim -->
<div id="login-required-modal" class="login-modal d-none">
    <div class="login-modal__content">
        <h5>Thông báo</h5>
        <p>Bạn cần đăng nhập để sử dụng chức năng yêu thích.</p>
        <button id="close-login-modal" class="btn btn-primary btn-sm">Đóng</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".favorite-btn").forEach(btn => {
            btn.addEventListener("click", function (e) {
                e.preventDefault();

                const isAuth = this.dataset.auth === "1";
                const icon = this.querySelector("i");

                // CHƯA LOGIN → KHÔNG ĐỔI ICON
                if (!isAuth) {
                    openLoginRequiredModal();
                    return;
                }

                const url = this.dataset.url;

                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) return;

                        icon.classList.toggle("fa-solid", data.is_favorite);
                        icon.classList.toggle("fa-regular", !data.is_favorite);
                    });
            });
        });

        document.getElementById("close-login-modal")
            ?.addEventListener("click", closeLoginRequiredModal);
    });

    function openLoginRequiredModal() {
        document.getElementById("login-required-modal")
            ?.classList.remove("d-none");
    }

    function closeLoginRequiredModal() {
        document.getElementById("login-required-modal")
            ?.classList.add("d-none");
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(
                        cookie.slice(name.length + 1)
                    );
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>

<!-- Autocomplete Script -->
<!--<script src="{% static 'js/autocomplete.js' %}"></script>-->
{% endblock %}