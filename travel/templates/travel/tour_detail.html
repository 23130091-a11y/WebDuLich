{% extends 'travel/baseIndex.html' %}
{% load static %}


{% block title %}{{ tour.name }} - H·ªá th·ªëng ƒë·∫∑t tour chuy√™n nghi·ªáp{% endblock %}

{% block extra_css %}

<style>
    :root { 
        --primary-color: #0d6efd; 
        --orange-action: #ff5722; 
        --price-color: #e31c25; 
        --bg-light: #f8f9fa;
        --star-color: #ffc107;
    }
    
    /* Layout */
    .sync-height { display: flex; align-items: flex-start; }
    .tour-sidebar-container { position: sticky; top: 90px; height: fit-content; z-index: 10; }
    
    /* Price Card */
    .price-card { background: #fff; border-top: 5px solid var(--orange-action); border-radius: 15px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .price-box { background: #fff5f2; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .price-amount { font-size: 2.4rem; color: var(--price-color); font-weight: 800; }
    .btn-booking { background: linear-gradient(45deg, #ff5722, #ff9800); color: white; border: none; padding: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; transition: 0.3s; }
    .btn-booking:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,87,34,0.4); color: white; }

    /* Nearby Services & Tabs */
    .service-card { transition: all 0.3s ease; border: 1px solid #eee; height: 100%; background: #fff; }
    .service-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .img-service { width: 70px; height: 70px; object-fit: cover; border-radius: 10px; }
    .nav-pills .nav-link { color: #666; font-weight: 600; border-radius: 50px; padding: 8px 20px; }
    .nav-pills .nav-link.active { background-color: var(--primary-color); shadow: 0 4px 10px rgba(13,110,253,0.2); }

    /* Star Rating System */
    .star-rating-input-ltr { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 5px; }
    .star-rating-input-ltr input { display: none; }
    .star-rating-input-ltr label { font-size: 1.8rem; color: #ddd; cursor: pointer; transition: 0.2s; }
    .star-rating-input-ltr input:checked ~ label, .star-rating-input-ltr label:hover, .star-rating-input-ltr label:hover ~ label { color: var(--star-color); }

    .section-title { border-left: 4px solid var(--primary-color); padding-left: 15px; margin-bottom: 25px; font-weight: 700; color: #333; }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05); border-radius: 1rem; margin-bottom: 1.5rem; }
    .review-item { border-bottom: 1px solid #eee; padding: 20px 0; }
    .sentiment-tag { font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}
{% load humanize %}

{% block content %}
<main class="py-4 bg-light">
    <div class="container">
        <div class="row g-4 sync-height">
            
            <div class="col-lg-8">
                <div class="mb-4">
                    {% if tour.image_main %}
                        <img src="{{ tour.image_main.url }}" class="img-fluid rounded-4 shadow-sm w-100" style="max-height: 500px; object-fit: cover;">
                    {% else %}
                        <div class="bg-secondary text-white rounded-4 d-flex align-items-center justify-content-center" style="height: 400px;">Kh√¥ng c√≥ ·∫£nh</div>
                    {% endif %}
                </div>

                <section class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h1 class="fw-bold mb-1 text-dark">{{ tour.name }}</h1>
                        <div class="d-flex align-items-center mb-3">
                            <div class="text-warning me-2">
                                <span class="fw-bold text-dark me-1">{{ tour.average_rating|floatformat:1 }}</span>
                                {% for i in "12345" %}
                                    <i class="{% if forloop.counter <= tour.average_rating %}fa-solid{% else %}fa-regular{% endif %} fa-star small"></i>
                                {% endfor %}
                            </div>
                            <span class="text-muted border-start ps-2 small">
                                <i class="fa-solid fa-comment-dots me-1"></i>{{ tour.total_reviews }} ƒë√°nh gi√°
                            </span>
                        </div>

                        {% comment %} <div class="row g-0 mb-3 py-3 border rounded-3 bg-white shadow-sm">
                            <div class="col-6 col-md-4 border-end-md">
                                <div class="d-flex align-items-center px-3 justify-content-center justify-content-md-start">
                                    <i class="fa-solid fa-location-dot text-danger fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">ƒêi·ªÉm ƒë·∫øn</div>
                                        <div class="fw-bold small text-dark">{{ tour.destination.location }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-4 border-end-md">
                                <div class="d-flex align-items-center px-3 justify-content-center justify-content-md-start border-start-mobile">
                                    <i class="fa-solid fa-clock text-primary fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Th·ªùi gian</div>
                                        <div class="fw-bold small text-dark">{{ tour.duration }} Ng√†y</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-6 col-md-4 mt-3 mt-md-0">
                                <div class="d-flex align-items-center px-3 justify-content-center justify-content-md-start border-start-mobile">
                                    <i class="fa-solid fa-tags text-info fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Lo·∫°i h√¨nh</div>
                                        <div class="fw-bold small text-dark">{{ tour.category.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </div> {% endcomment %}

                        <h5 class="section-title mb-1 fw-bold"><i class="fa-solid fa-circle-info me-2 text-primary"></i>Chi ti·∫øt h√†nh tr√¨nh</h5>

                        <div class="description-text" style="margin-top: -10px !important;">
                            {{ tour.details|linebreaksbr }}
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-3">
                            <a href="#reviews-section" class="btn btn-outline-primary">
                                <i class="fa-solid fa-comments me-2"></i>Xem {{ reviews|length }} ƒë√°nh gi√°
                            </a>

                            <button type="button" id="btnWriteReviewTop" class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                <i class="fa-solid fa-pen me-2"></i>Vi·∫øt ƒë√°nh gi√°
                            </button>

                            <button class="btn btn-outline-info" onclick="window.print()">
                                <i class="fa-solid fa-print me-2"></i>In th√¥ng tin
                            </button>
                        </div>
                    </div>
                </section>

                <style>
                    .description-text {
                        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        font-size: 0.95rem;
                        line-height: 1.6; /* Gi·∫£m nh·∫π t·ª´ 1.8 xu·ªëng 1.6 ƒë·ªÉ nh√¨n ƒë·∫∑c h∆°n */
                        color: #4b5563;
                        text-align: justify;
                        
                        /* Ch·ªëng kho·∫£ng tr·∫Øng th·ª´a */
                        display: block;
                        margin-top: 0 !important; 
                        padding-top: 0 !important;
                        
                        /* Gi·ªØ xu·ªëng d√≤ng nh∆∞ng b·ªè c√°c kho·∫£ng tr·∫Øng d∆∞ th·ª´a ·ªü ƒë·∫ßu/cu·ªëi */
                        white-space: pre-line; 
                    }
                </style>

                <section class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="section-title mb-3 fw-bold"><i class="fa-solid fa-map-location-dot me-2 text-primary"></i>B·∫£n ƒë·ªì ƒëi·ªÉm t·∫≠p trung</h5>
                        <div id="map" style="height: 350px; border-radius: 15px; border: 1px solid #eee; background-color: #f8f9fa;"></div>
                        <div class="mt-3 p-3 bg-light rounded-3 d-flex align-items-start">
                            <i class="fa-solid fa-map-pin text-danger mt-1 me-2"></i>
                            <div>
                                <span class="fw-bold small d-block">ƒê·ªãa ch·ªâ t·∫≠p trung:</span>
                                <span class="text-muted small">{{ tour.meeting_point|default:tour.address_detail }}</span>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="card border-0 shadow-sm" id="reviews-section">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="fa-solid fa-comments text-primary me-2"></i>ƒê√°nh gi√° t·ª´ du kh√°ch
                            </h5>
                            <button class="btn btn-primary btn-sm rounded-pill px-3" 
                                    {% if not user.is_authenticated %}
                                        data-bs-toggle="modal" data-bs-target="#authModal"
                                    {% else %}
                                        data-bs-toggle="collapse" data-bs-target="#reviewForm"
                                    {% endif %}>
                                <i class="fa-solid fa-pen-to-square me-1"></i>Vi·∫øt ƒë√°nh gi√°
                            </button>
                        </div>

                        <div class="collapse mb-4" id="reviewForm">
                            <div class="p-4 bg-light rounded-4 border">
                                {% if user.is_authenticated %}
                                    <h6 class="mb-3 fw-bold">
                                        <i class="fa-solid fa-paper-plane me-2 text-primary"></i>Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n
                                        <span class="badge bg-success-subtle text-success ms-2 fw-normal">
                                            <i class="fa-solid fa-check-circle"></i> T√†i kho·∫£n ƒë√£ x√°c minh
                                        </span>
                                    </h6>
                                    
                                    <form id="reviewFormSubmit">
                                        <input type="hidden" id="tourId" value="{{ tour.id }}"> 
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">T√™n c·ªßa b·∫°n</label>
                                                <input type="text" id="authorName" class="form-control bg-white" 
                                                    value="{{ user.get_full_name|default:user.username }}" readonly>
                                                <small class="text-muted x-small">T√™n hi·ªÉn th·ªã theo t√†i kho·∫£n c·ªßa b·∫°n</small>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">ƒê√°nh gi√° <span class="text-danger">*</span></label>
                                                <div class="d-flex flex-row-reverse justify-content-end gap-1 star-rating-input" id="starRatingContainer">
                                                    {% for i in "54321" %}
                                                    <input type="radio" class="btn-check" name="rating" id="star{{ i }}" value="{{ i }}" {% if i == "5" %}checked{% endif %}>
                                                    <label for="star{{ i }}" class="text-muted cursor-pointer p-1">
                                                        <i class="fa-solid fa-star fs-5"></i>
                                                    </label>
                                                    {% endfor %}
                                                </div>
                                                <input type="hidden" id="ratingValue" value="5">
                                            </div>

                                            <div class="col-12">
                                                <label class="form-label small fw-bold">Nh·∫≠n x√©t c·ªßa b·∫°n</label>
                                                <textarea id="comment" class="form-control" rows="4" placeholder="Tour n√†y th·∫ø n√†o? B·∫°n c√≥ h√†i l√≤ng kh√¥ng..." maxlength="2000"></textarea>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small class="text-muted x-small"><i class="fa-solid fa-robot me-1"></i>H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch c·∫£m x√∫c ƒë√°nh gi√°</small>
                                                    <small class="text-muted x-small"><span id="charCount">0</span>/2000</small>
                                                </div>
                                            </div>

                                            <div class="col-12 text-end">
                                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="collapse" data-bs-target="#reviewForm">H·ªßy</button>
                                                <button type="submit" class="btn btn-primary btn-sm px-4" id="submitReviewBtn">G·ª≠i ƒë√°nh gi√°</button>
                                            </div>
                                        </div>
                                    </form>

                                {% else %}
                                    <div class="text-center py-3">
                                        <div class="mb-3">
                                            <i class="fa-solid fa-user-shield fa-3x text-muted opacity-50"></i>
                                        </div>
                                        <h6 class="fw-bold">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°</h6>
                                        <p class="text-muted small mb-4">ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh kh√°ch quan, ch·ªâ th√†nh vi√™n m·ªõi c√≥ th·ªÉ chia s·∫ª tr·∫£i nghi·ªám.</p>
                                        <div class="d-flex justify-content-center gap-2">
                                            <button type="button" 
                                                class="btn btn-primary btn-sm rounded-pill px-4" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#authModal"> ƒêƒÉng nh·∫≠p ngay
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-4" data-bs-toggle="collapse" data-bs-target="#reviewForm">ƒê√≥ng</button>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div id="reviewsList">
                            {% if reviews %}
                                <div class="mb-4 d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3">{{ total_reviews }} nh·∫≠n x√©t</span>
                                    <small class="text-muted">Trang {{ reviews.number }}/{{ reviews.paginator.num_pages }}</small>
                                </div>

                                {% for review in reviews %}
                                <div class="review-item border-bottom pb-4 mb-4" id="review-{{ review.id }}">
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex align-items-start">
                                            <div class="avatar-sm me-3">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 48px; height: 48px;">
                                                    {{ review.author_name|slice:":1"|upper }}
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h6 class="mb-0 fw-bold text-dark">
                                                    {{ review.author_name }}
                                                    
                                                    {% if review.user %}
                                                        <i class="fa-solid fa-circle-check text-primary small ms-1" title="Th√†nh vi√™n ƒë√£ x√°c minh"></i>
                                                    {% else %}
                                                        <span class="badge bg-light text-muted fw-normal ms-1" style="font-size: 0.6rem;">Kh√°ch v√£ng lai</span>
                                                    {% endif %}
                                                
                                                    
                                                    {% if review.is_verified_purchase %}
                                                        <span class="badge bg-success-subtle text-success fw-normal ms-2" style="font-size: 0.65rem;">
                                                            <i class="fa-solid fa-bag-shopping me-1"></i>Kh√°ch ƒë√£ tr·∫£i nghi·ªám tour
                                                        </span>
                                                    {% endif %}
                                                </h6>

                                                <div class="text-warning small my-1">
                                                    {% for i in "12345" %}
                                                        <i class="{% if forloop.counter <= review.rating %}fa-solid{% else %}fa-regular{% endif %} fa-star"></i>
                                                    {% endfor %}
                                                    <span class="text-muted ms-2 x-small">{{ review.created_at|date:"d/m/Y" }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="dropdown">
                                            <button class="btn btn-link text-muted p-0 shadow-none" data-bs-toggle="dropdown">
                                                <i class="fa-solid fa-ellipsis-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                                <li>
                                                    <a class="dropdown-item small report-btn {% if review.id in reported_ids %}text-danger disabled{% endif %}" 
                                                    data-review-id="{{ review.id }}" data-is-tour="true" href="javascript:void(0)">
                                                        <i class="fa-solid fa-flag me-2 text-warning"></i>
                                                        <span>{% if review.id in reported_ids %}ƒê√£ b√°o c√°o{% else %}B√°o c√°o vi ph·∫°m{% endif %}</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="ps-5 mt-2">
                                        <p class="text-secondary small mb-3">{{ review.comment }}</p>
                                        
                                        <div class="d-flex flex-wrap gap-2 mb-3">
                                            {% if review.positive_keywords %}
                                                {% for tag in review.positive_keywords %}
                                                <span class="badge bg-success-subtle text-success fw-normal x-small">
                                                    <i class="fa-solid fa-thumbs-up me-1"></i>{{ tag }}
                                                </span>
                                                {% endfor %}
                                            {% endif %}
                                            
                                            {% if review.sentiment_score %}
                                                <span class="badge {% if review.sentiment_score > 0 %}bg-info-subtle text-info{% else %}bg-secondary-subtle text-secondary{% endif %} fw-normal x-small">
                                                    <i class="fa-solid fa-robot me-1"></i>AI: {{ review.sentiment_score|floatformat:2 }}
                                                </span>
                                            {% endif %}
                                        </div>

                                        <div class="d-flex align-items-center gap-3">
                                            <button class="btn btn-sm vote-btn p-0 text-muted shadow-none border-0 bg-transparent" 
                                                    data-review-id="{{ review.id }}" data-vote="helpful" data-is-tour="true"> 
                                                <i class="fa-regular fa-thumbs-up me-1"></i> 
                                                H·ªØu √≠ch (<span class="helpful-count">{{ review.helpful_count }}</span>)
                                            </button>

                                            <button class="btn btn-sm vote-btn p-0 text-muted shadow-none border-0 bg-transparent" 
                                                    data-review-id="{{ review.id }}" data-vote="not_helpful" data-is-tour="true"> 
                                                <i class="fa-regular fa-thumbs-down me-1"></i> 
                                                Kh√¥ng h·ªØu √≠ch (<span class="not-helpful-count">{{ review.not_helpful_count }}</span>)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                {% if reviews.has_other_pages %}
                                <nav class="mt-4">
                                    <ul class="pagination pagination-sm justify-content-center">
                                        {% if reviews.has_previous %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.previous_page_number }}#reviewsList"><i class="fa-solid fa-chevron-left"></i></a></li>
                                        {% endif %}

                                        {% for num in reviews.paginator.page_range %}
                                            {% if reviews.number == num %}
                                                <li class="page-item active"><span class="page-link border-0 shadow-none">{{ num }}</span></li>
                                            {% elif num > reviews.number|add:'-3' and num < reviews.number|add:'3' %}
                                                <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ num }}#reviewsList">{{ num }}</a></li>
                                            {% endif %}
                                        {% endfor %}

                                        {% if reviews.has_next %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.next_page_number }}#reviewsList"><i class="fa-solid fa-chevron-right"></i></a></li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}

                                {% if reviews.has_other_pages %}
                                <nav class="mt-4">
                                    <ul class="pagination pagination-sm justify-content-center">
                                        {% if reviews.has_previous %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.previous_page_number }}#reviewsList"><i class="fa-solid fa-chevron-left"></i></a></li>
                                        {% endif %}
                                        {% if reviews.has_next %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.next_page_number }}#reviewsList"><i class="fa-solid fa-chevron-right"></i></a></li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}

                            {% else %}
                                <div class="text-center py-5 bg-light rounded-4 border-dashed">
                                    <i class="fa-solid fa-comment-dots fa-3x text-muted mb-3 opacity-25"></i>
                                    <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n!</p>
                                    <button class="btn btn-primary btn-sm rounded-pill" 
                                            {% if not user.is_authenticated %}
                                                data-bs-toggle="modal" data-bs-target="#authModal"
                                            {% else %}
                                                data-bs-toggle="collapse" data-bs-target="#reviewForm"
                                            {% endif %}>Vi·∫øt ƒë√°nh gi√° ƒë·∫ßu ti√™n</button>
                                </div>
                            {% endif %}
                        </div>

                    </div> 
                </div>

                <style>
                    .x-small { font-size: 0.75rem; }
                    .cursor-pointer { cursor: pointer; }
                    .section-title { border-left: 4px solid #0d6efd; padding-left: 15px; }
                    
                    /* 1. Reset m√†u m·∫∑c ƒë·ªãnh cho label (b·ªè text-muted ·ªü HTML n·∫øu c·∫ßn, ho·∫∑c √©p m√†u ·ªü ƒë√¢y) */
                    .star-rating-input label { 
                        color: #ddd !important; /* M√†u x√°m khi ch∆∞a ch·ªçn */
                        transition: all 0.2s;
                    }

                    /* 2. Khi di chu·ªôt v√†o: Sao hi·ªán t·∫°i v√† c√°c sao b√™n PH·∫¢I (theo code) s·∫Ω v√†ng l√™n */
                    .star-rating-input label:hover, 
                    .star-rating-input label:hover ~ label { 
                        color: #ffc107 !important; 
                    }

                    /* 3. Khi ƒë√£ click ch·ªçn: Sao ƒë√£ ch·ªçn v√† c√°c sao b√™n PH·∫¢I (theo code) gi·ªØ m√†u v√†ng */
                    .star-rating-input input:checked ~ label { 
                        color: #ffc107 !important; 
                    }
                    
                    /* Fix l·ªói: Khi ƒëang ch·ªçn sao th·∫•p m√† di chu·ªôt v√†o sao cao h∆°n th√¨ v·∫´n ph·∫£i s√°ng */
                    .star-rating-input input:checked + label:hover,
                    .star-rating-input input:checked + label:hover ~ label {
                        color: #ffc107 !important;
                    }

                    .review-item:last-child { border-bottom: none !important; }
                    .pagination .page-link { border-radius: 8px; margin: 0 3px; color: #666; }
                    .pagination .page-item.active .page-link { background-color: #0d6efd; border-color: #0d6efd; }
                    .vote-btn * { pointer-events: none;}
                    /* √âp modal-xl r·ªông t·ªëi ƒëa tr√™n m√†n h√¨nh l·ªõn */
                    /* √âp Modal XL r·ªông ra 95% m√†n h√¨nh */
                    /* Ch·ªâ t√°c ƒë·ªông v√†o Modal c√≥ id l√† mapModal */
                    #mapModal .modal-content {
                        max-width: none !important; /* Lo·∫°i b·ªè gi·ªõi h·∫°n 500px */
                        width: 100% !important;
                        padding: 0 !important; /* Lo·∫°i b·ªè padding 25px ƒëang c√≥ ƒë·ªÉ b·∫£n ƒë·ªì s√°t m√©p ƒë·∫πp h∆°n */
                    }

                    /* √âp modal-xl r·ªông ra theo chu·∫©n m√†n h√¨nh l·ªõn */
                    @media (min-width: 1200px) {
                        #mapModal .modal-xl {
                            max-width: 90% !important; 
                        }
                    }

                    /* TƒÉng chi·ªÅu cao iframe ƒë·ªÉ xem b·∫£n ƒë·ªì s∆∞·ªõng h∆°n */
                    #mapIframe {
                        height: 75vh !important;
                        display: block;
                    }
                </style>
            </div>       

            <div class="col-lg-4">
                <div class="tour-sidebar-container">
                    <div class="card price-card mb-4 border-0 shadow-sm" style="border-radius: 20px;">
                        <div class="card-body p-4 text-center">
                            <div class="price-box mb-3">
                                <small class="text-muted fw-bold d-block mb-1">GI√Å CH·ªà T·ª™</small>
                                <div>
                                    <span class="text-danger fw-bold fs-5">{{ tour.price|floatformat:0|intcomma }}ƒë</span>
                            </div>

                            <div class="d-grid gap-2">
                                {% if user.is_authenticated %}
                                    <a href="{% url 'travel:book_tour' tour.id %}" class="btn btn-booking btn-lg shadow rounded-pill">
                                        <i class="fa-solid fa-cart-plus me-2"></i>ƒê·∫∂T TOUR NGAY
                                    </a>
                                {% else %}
                                    <button type="button" 
                                            class="btn btn-booking btn-lg shadow rounded-pill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#authModal">
                                        <i class="fa-solid fa-lock me-2"></i>ƒêƒÇNG NH·∫¨P ƒê·ªÇ ƒê·∫∂T TOUR
                                    </button>
                                    <small class="text-muted mt-2">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ƒë·∫∑t ch·ªó</small>
                                {% endif %}
                            </div>
                        </div>

                        {% if not user.is_authenticated %}
                        <div class="card-footer bg-light border-0 py-3 text-center" style="border-radius: 0 0 20px 20px;">
                            <p class="small text-muted mb-0">
                                <i class="fa-solid fa-circle-info me-1"></i> 
                                ƒêƒÉng k√Ω th√†nh vi√™n ƒë·ªÉ nh·∫≠n th√™m ∆∞u ƒë√£i t·ª´ ch√∫ng t√¥i.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-cloud-sun text-warning"></i> Th·ªùi ti·∫øt
                            </h5>
                            {% if weather_info and not weather_info.error %}
                            {% if weather_info.is_current %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">{{ weather_info.icon|default:"üå°Ô∏è" }}</span>
                                <div>
                                    <p class="mb-1"><strong>{{ weather_info.weather_desc|default:"Hi·ªán t·∫°i" }}</strong></p>
                                    <p class="mb-1">üå°Ô∏è Nhi·ªát ƒë·ªô: <strong>{{ weather_info.temperature }}¬∞C</strong>
                                        {% if weather_info.feels_like %}
                                        <small class="text-muted">(C·∫£m gi√°c {{ weather_info.feels_like }}¬∞C)</small>
                                        {% endif %}
                                    </p>
                                    {% if weather_info.humidity %}
                                    <p class="mb-1">üíß ƒê·ªô ·∫©m: {{ weather_info.humidity }}%</p>
                                    {% endif %}
                                    {% if weather_info.precipitation and weather_info.precipitation > 0 %}
                                    <p class="mb-1">üåßÔ∏è L∆∞·ª£ng m∆∞a: {{ weather_info.precipitation }} mm</p>
                                    {% endif %}
                                    <p class="mb-0">üí® Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            {% if weather_info.time %}
                            <small class="text-muted d-block mt-2">C·∫≠p nh·∫≠t: {{ weather_info.time }}</small>
                            {% endif %}
                            {% else %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">{{ weather_info.icon }}</span>
                                <div>
                                    <p class="mb-1"><strong>{{ weather_info.weather_desc }}</strong></p>
                                    <p class="mb-1">üå°Ô∏è {{ weather_info.temp_min }}¬∞C - {{ weather_info.temp_max }}¬∞C</p>
                                    {% if weather_info.precipitation_prob %}
                                    <p class="mb-1">üåßÔ∏è Kh·∫£ nƒÉng m∆∞a: {{ weather_info.precipitation_prob }}%</p>
                                    {% endif %}
                                    <p class="mb-1">üíß L∆∞·ª£ng m∆∞a: {{ weather_info.precipitation|default:"0" }} mm</p>
                                    <p class="mb-0">üí® Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Ng√†y: {{ weather_info.date }}</small>
                            {% endif %}
                            {% elif weather_info.error %}
                            <p class="text-muted">{{ weather_info.error }}</p>
                            {% else %}
                            <p class="text-muted small">
                                Nh·∫≠p ng√†y ƒëi ƒë·ªÉ xem d·ª± b√°o th·ªùi ti·∫øt.
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Kh√°ch s·∫°n g·∫ßn ƒë√≥ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-hotel text-primary"></i> Kh√°ch s·∫°n g·∫ßn ƒë√≥
                            </h5>
                            <div id="nearbyHotels">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <small class="text-muted ms-2">ƒêang t·∫£i...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Qu√°n ƒÉn g·∫ßn ƒë√≥ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-utensils text-danger"></i> Qu√°n ƒÉn g·∫ßn ƒë√≥
                            </h5>
                            <div id="nearbyRestaurants">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                                    <small class="text-muted ms-2">ƒêang t·∫£i...</small>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4">
                                <i class="fa-solid fa-compass text-success me-2"></i>Tour t∆∞∆°ng t·ª±
                            </h5>
                            {% if related_tours %}
                                {% for rt in related_tours %}
                                <div class="d-flex align-items-center mb-3 pb-3 border-bottom last-child-border-0">
                                    <div class="flex-shrink-0">
                                        {% if rt.image_main %}
                                            <img src="{{ rt.image_main.url }}" class="rounded shadow-sm" style="width: 65px; height: 65px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded" style="width: 65px; height: 65px;"></div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex-grow-1 ms-3">
                                        <a href="{% url 'travel:tour_detail' rt.slug %}" class="text-decoration-none text-dark card-hover-link">
                                            <strong class="d-block mb-1 small lh-sm">{{ rt.name }}</strong>
                                        </a>
                                        <div class="small text-muted mb-1">
                                            <i class="fa-solid fa-location-dot text-danger me-1"></i> {{ rt.destination.name }}
                                        </div>
                                        <div class="text-danger fw-bold small">
                                            {{ rt.price|floatformat:0 |intcomma }}ƒë
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-0">Kh√¥ng c√≥ tour t∆∞∆°ng t·ª±.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
            </div>
        </div>
    </div>
    <div class="modal fade" id="mapModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-map-location-dot me-2"></i>B·∫£n ƒë·ªì chi ti·∫øt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="mapIframe" width="100%" height="650px" 
                            style="border:0; display: block;" 
                            allowfullscreen="" loading="lazy"></iframe>
                </div>
            </div>
        </div>
    </div>
</main>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // L·∫•y ƒë·ªëi t∆∞·ª£ng form v√† n√∫t ph√≠a tr√™n
    const reviewFormEl = document.getElementById('reviewForm');
    const btnTop = document.getElementById('btnWriteReviewTop');

    // L·∫Øng nghe s·ª± ki·ªán "ƒëang m·ªü" c·ªßa Bootstrap Collapse
    reviewFormEl.addEventListener('show.bs.collapse', function () {
        // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ hi·ªáu ·ª©ng m·ªü b·∫Øt ƒë·∫ßu r·ªìi m·ªõi cu·ªôn
        setTimeout(() => {
            const yOffset = -100; // Kho·∫£ng c√°ch b√π tr·ª´ ƒë·ªÉ kh√¥ng b·ªã Menu che m·∫•t
            const y = reviewFormEl.getBoundingClientRect().top + window.pageYOffset + yOffset;
            
            window.scrollTo({
                top: y, 
                behavior: 'smooth'
            });
        }, 100);
    });

    // N·∫øu form ƒê√É M·ªû R·ªíI m√† kh√°ch v·∫´n b·∫•m n√∫t tr√™n, th√¨ ch·ªâ c·∫ßn cu·ªôn xu·ªëng
    btnTop.addEventListener('click', function() {
        if (reviewFormEl.classList.contains('show')) {
            const yOffset = -100;
            const y = reviewFormEl.getBoundingClientRect().top + window.pageYOffset + yOffset;
            window.scrollTo({top: y, behavior: 'smooth'});
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. L·∫•y t·ªça ƒë·ªô g·ªëc
    const lat = parseFloat("{{ tour.start_latitude|default:tour.destination.latitude|stringformat:'f' }}".replace(',', '.'));
    const lon = parseFloat("{{ tour.start_longitude|default:tour.destination.longitude|stringformat:'f' }}".replace(',', '.'));

    if (!lat || !lon) return;

    // --- PH·∫¶N 1: B·∫¢N ƒê·ªí LEAFLET (Gi·ªØ nguy√™n cho trang ch√≠nh) ---
    const mapElement = document.getElementById('map');
    if (mapElement) {
        var map = L.map('map').setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        L.marker([lat, lon]).addTo(map)
            .bindPopup("<b>ƒêi·ªÉm t·∫≠p trung:</b><br>{{ tour.meeting_point|default:tour.name }}")
            .openPopup();
        setTimeout(() => { map.invalidateSize(); }, 400);
    }

    // --- PH·∫¶N 2: H√ÄM M·ªû MODAL B·∫¢N ƒê·ªí ---
    window.openMapModal = function(url) {
        const iframe = document.getElementById('mapIframe');
        if (iframe) {
            // Th√™m &output=embed ƒë·ªÉ cho ph√©p hi·ªÉn th·ªã trong iframe
            iframe.src = url + "&output=embed";
            const myModal = new bootstrap.Modal(document.getElementById('mapModal'));
            myModal.show();
        }
    };

    // --- PH·∫¶N 3: T·∫¢I ƒê·ªäA ƒêI·ªÇM XUNG QUANH ---
    function loadNearby(type, elementId, categoryName) {
        const container = document.getElementById(elementId);
        if (!container) return;

        const searchQuery = (type === 'hotel') ? 'Kh√°ch s·∫°n' : 'Qu√°n ƒÉn';
        // Link t√¨m ki·∫øm chu·∫©n cho Embed
        const googleMapsSearchUrl = `https://www.google.com/maps?q=${encodeURIComponent(searchQuery)}+g·∫ßn+${lat},${lon}&hl=vi`;

        fetch(`/api/nearby/?lat=${lat}&lon=${lon}&type=${type}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = ''; 
                const destinationName = "{{ tour.destination.name|escapejs }}";

                let htmlHeader = `
                    <button onclick="openMapModal('${googleMapsSearchUrl}')" class="btn btn-outline-primary w-100 mb-3 text-start shadow-sm">
                        <i class="fa-solid fa-map-location-dot me-2"></i> Xem ${categoryName} tr√™n b·∫£n ƒë·ªì
                    </button>
                    <p class="small fw-bold mb-2 text-muted">Ho·∫∑c t√¨m tr√™n:</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        ${type === 'hotel' ? `
                            <a href="https://www.booking.com/searchresults.vi.html?ss=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Booking.com</a>
                            <a href="https://www.agoda.com/search?query=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Agoda</a>
                        ` : `
                            <a href="https://www.foody.vn/tim-kiem/${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Foody</a>
                            <a href="https://shopeefood.vn/search?keyword=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">ShopeeFood</a>
                        `}
                    </div>
                    <hr>
                `;
                container.insertAdjacentHTML('beforeend', htmlHeader);

                const items = data.results || data.places || (Array.isArray(data) ? data : []);
                items.forEach(item => {
                    const iLat = item.lat || item.latitude;
                    const iLon = item.lon || item.longitude;
                    const itemGMapUrl = `https://www.google.com/maps?q=${iLat},${iLon}&hl=vi`;

                    const div = document.createElement('div');
                    div.className = 'list-group-item list-group-item-action mb-2 border-0 shadow-sm rounded';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="cursor:pointer" class="item-info" onclick="openMapModal('${itemGMapUrl}')">
                                <div class="fw-bold small">${item.name}</div>
                                <small class="text-muted">${item.address || 'ƒêang c·∫≠p nh·∫≠t...'}</small>
                            </div>
                            <button onclick="openMapModal('${itemGMapUrl}')" class="btn btn-sm btn-light text-danger border">
                                <i class="fa-solid fa-location-dot"></i>
                            </button>
                        </div>
                    `;
                    
                    if (typeof map !== 'undefined' && map) {
                        L.circleMarker([iLat, iLon], {radius: 5, color: type==='hotel'?'blue':'red'}).addTo(map)
                        .bindPopup(item.name);
                    }
                    container.appendChild(div);
                });
            })
            .catch(err => console.error("L·ªói t·∫£i " + type, err));
    }

    loadNearby('hotel', 'nearbyHotels', 'Kh√°ch s·∫°n');
    loadNearby('restaurant', 'nearbyRestaurants', 'Qu√°n ƒÉn');
});
</script>

<script>
    const VOTE_API_URL = "{% url 'travel:api_vote_review' %}";
    const REPORT_API_URL = "{% url 'travel:api_report_review' %}";

    // H√†m ki·ªÉm tra cooldown d√πng chung cho t·∫•t c·∫£ h√†nh ƒë·ªông
    function isSpamming(actionName, seconds) {
        const now = Date.now();
        const lastTime = localStorage.getItem(`last_${actionName}_time`) || 0;
        const cooldownMS = seconds * 1000;

        if (now - lastTime < cooldownMS) {
            const timeLeft = Math.ceil((cooldownMS - (now - lastTime)) / 1000);
            alert(`Thao t√°c qu√° nhanh! Vui l√≤ng ƒë·ª£i ${timeLeft} gi√¢y.`);
            return true; // ƒêang spam
        }
        return false; // Kh√¥ng spam
    }

    // H√†m c·∫≠p nh·∫≠t m·ªëc th·ªùi gian sau khi th√†nh c√¥ng
    function updateActionTime(actionName) {
        localStorage.setItem(`last_${actionName}_time`, Date.now());
    }

    function checkAuthAndRun(callback) {
        const access = localStorage.getItem("access");
        if (access) {
            callback();
        } else {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, b·∫≠t Modal ƒëƒÉng nh·∫≠p
            const authModalElement = document.getElementById('authModal');
            if (authModalElement) {
                const authModal = new bootstrap.Modal(authModalElement);
                // Hi·ªÉn th·ªã th√¥ng b√°o y√™u c·∫ßu trong Modal n·∫øu c√≥ v√πng Alert
                const authAlert = document.getElementById('authAlert');
                if (authAlert) {
                    authAlert.classList.remove('d-none');
                    authAlert.className = "alert alert-warning";
                    authAlert.textContent = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y!";
                }
                authModal.show();
            } else {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y!");
            }
        }
    }

    // 1. B·ªô ƒë·∫øm k√Ω t·ª± (C·∫≠p nh·∫≠t ID cho Tour)
    const tourCommentInput = document.getElementById('tourComment'); // ƒê·ªïi ID ƒë·ªÉ kh·ªõp HTML Tour
    const tourCharCount = document.getElementById('tourCharCount');
    if (tourCommentInput && tourCharCount) {
        tourCommentInput.addEventListener('input', () => {
            tourCharCount.textContent = tourCommentInput.value.length;
            if (tourCommentInput.value.length > 1800) {
                tourCharCount.classList.add('text-warning');
            } else {
                tourCharCount.classList.remove('text-warning');
            }
        });
    }

    // 2. X·ª≠ l√Ω Star Rating (D√πng chung logic LTR c·ªßa b·∫°n)
    const starLabels = document.querySelectorAll('.star-label-ltr');
    const ratingInput = document.getElementById('tourRatingValue'); // Hidden input l∆∞u s·ªë sao

    function updateStars(value) {
        starLabels.forEach((label, index) => {
            const starValue = index + 1;
            label.style.color = starValue <= value ? '#ffc107' : '#ddd';
            if (starValue <= value) label.classList.add('active');
            else label.classList.remove('active');
        });
    }

    // Kh·ªüi t·∫°o 4 sao m·∫∑c ƒë·ªãnh
    updateStars(4);

    starLabels.forEach((label, index) => {
        const starValue = index + 1;
        label.addEventListener('click', () => {
            ratingInput.value = starValue;
            updateStars(starValue);
        });

        label.addEventListener('mouseenter', () => {
            starLabels.forEach((l, i) => {
                l.style.color = (i + 1 <= starValue) ? '#ffc107' : '#ddd';
            });
        });
    });

    document.querySelectorAll('.star-rating-input input[name="rating"]').forEach(input => {
        input.addEventListener('change', function() {
            document.getElementById('ratingValue').value = this.value;
            console.log("ƒê√£ ch·ªçn:", this.value, "sao");
        });
    });

    // 3. Submit Review b·∫±ng AJAX
    const tourReviewForm = document.getElementById('reviewFormSubmit');

    if (tourReviewForm) {
        tourReviewForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (isSpamming('comment', 30)) return;

            // L·∫•y ƒë√∫ng c√°c gi√° tr·ªã d·ª±a tr√™n ID th·ª±c t·∫ø trong HTML
            // L∆∞u √Ω: Ph·∫£i d√πng ID 'tourId' (ho·∫∑c destinationId t√πy b·∫°n ƒë·∫∑t ·ªü input hidden)
            const tourIdInput = document.getElementById('destinationId') || document.getElementById('tourId');
            const authorNameInput = document.getElementById('authorName');
            const ratingInput = document.getElementById('ratingValue'); // Hidden input t·ª´ star-rating
            const commentInput = document.getElementById('tourComment') || document.getElementById('comment');

            if (!tourIdInput || !commentInput.value.trim()) {
                alert("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°!");
                return;
            }

            const payload = {
                tour_id: tourIdInput.value,
                author_name: authorNameInput ? authorNameInput.value : 'Kh√°ch',
                rating: ratingInput ? ratingInput.value : 5,
                comment: document.getElementById('comment').value.trim()
            };

            const submitBtn = document.getElementById('submitReviewBtn');
            if (submitBtn) submitBtn.disabled = true; // Ch·ªëng spam click
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

            fetch('/api/tour_review/', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateActionTime('comment');
                    location.reload(); 
                } else {
                    alert('L·ªói: ' + data.error);
                    if (submitBtn) submitBtn.disabled = false; submitBtn.innerHTML = originalText;
                }
            })
            .catch(err => {
                console.error('L·ªói fetch:', err);
                if (submitBtn) submitBtn.disabled = false; submitBtn.innerHTML = originalText;
            });
        });
    }

    let isProcessing = false;
    const COOLDOWN_MS = 2000;

    document.addEventListener('click', async function(e) {
        // --- 1. LOGIC VOTE ---
        const voteBtn = e.target.closest('.vote-btn');
        if (voteBtn) {
            e.preventDefault();

            if (isSpamming('vote', 2)) return;

            isProcessing = true;
            if (voteBtn) voteBtn.style.opacity = "0.5";

            checkAuthAndRun(async () => {
                // L·∫•y d·ªØ li·ªáu t·ª´ data- attributes c·ªßa n√∫t
                const reviewId = voteBtn.getAttribute('data-review-id');
                const voteType = voteBtn.getAttribute('data-vote'); // 'helpful' ho·∫∑c 'not_helpful'
                const isTour = String(voteBtn.getAttribute('data-is-tour')).toLowerCase() === "true";

                if (!reviewId) {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y review_id tr√™n n√∫t!");
                    return;
                }
                // Trong s·ª± ki·ªán click c·ªßa voteBtn
                try {
                    const response = await fetch(VOTE_API_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'X-CSRFToken': getCookie('csrftoken') 
                        },
                        body: JSON.stringify({ 
                            review_id: reviewId, 
                            vote_type: voteType, 
                            is_tour: isTour 
                        })
                    });
                    
                    const data = await response.json();

                    if (data.success) {
                        // T√¨m v√πng ch·ª©a (container) c·ªßa review v·ª´a ƒë∆∞·ª£c b·∫•m
                        const reviewItem = voteBtn.closest('.review-item');
                        
                        // 1. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
                        const helpfulSpan = reviewItem.querySelector('.helpful-count');
                        const notHelpfulSpan = reviewItem.querySelector('.not-helpful-count');
                        
                        if (helpfulSpan) helpfulSpan.textContent = data.helpful_count;
                        if (notHelpfulSpan) notHelpfulSpan.textContent = data.not_helpful_count;

                        // 2. Thay ƒë·ªïi m√†u s·∫Øc n√∫t ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ b·∫•m
                        // X√≥a m√†u c≈© c·ªßa c·∫£ 2 n√∫t trong c√πng 1 review
                        reviewItem.querySelectorAll('.vote-btn').forEach(btn => {
                            btn.classList.remove('text-primary', 'fw-bold');
                            btn.querySelector('i').className = btn.getAttribute('data-vote') === 'helpful' 
                                ? 'fa-regular fa-thumbs-up' 
                                : 'fa-regular fa-thumbs-down';
                        });

                        // Th√™m m√†u m·ªõi cho n√∫t v·ª´a b·∫•m
                        voteBtn.classList.add('text-primary', 'fw-bold');
                        const icon = voteBtn.querySelector('i');
                        if (voteType === 'helpful') {
                            icon.className = 'fa-solid fa-thumbs-up';
                        } else {
                            icon.className = 'fa-solid fa-thumbs-down';
                        }

                    } else {
                        alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                    }
                } catch (err) { 
                    console.error('Vote failed', err); 
                }
                finally {
                    isProcessing = false;
                    if (voteBtn) voteBtn.style.opacity = "1";
                }
                updateActionTime('vote');
            });   
            
        }

        // --- 2. LOGIC REPORT ---
        const reportBtn = e.target.closest('.report-btn');
        if (reportBtn) {
            e.preventDefault();

            if (isSpamming('report', 5)) return;


            isProcessing = true;
            if (voteBtn) voteBtn.style.opacity = "0.5";

            checkAuthAndRun(async () => {
                const reviewId = reportBtn.getAttribute('data-review-id');
                const isTour = String(reportBtn.getAttribute('data-is-tour')).toLowerCase() === "true";

                const reason = prompt("L√Ω do b√°o c√°o:\n1. Spam\n2. X√∫c ph·∫°m\n3. Gi·∫£ m·∫°o\n4. Kh√°c\n(Nh·∫≠p s·ªë 1-4):");
                if (!reason) return;

                const reasonMap = { '1': 'spam', '2': 'inappropriate', '3': 'fake', '4': 'other' };
                const reasonCode = reasonMap[reason] || 'other';

                try {
                    const response = await fetch(REPORT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ review_id: reviewId, reason: reasonCode, is_tour: isTour })
                    });
                    const data = await response.json();
                    
                    if (data.success || response.ok) {
                        alert(data.message || "ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!");
                        
                        const icon = reportBtn.querySelector('i');
                        if (icon) {
                            // ƒê·ªïi t·ª´ icon c·ªù (fa-flag) sang icon t√≠ch xanh ho·∫∑c d·∫•u ch·∫•m than
                            icon.className = 'fa-solid fa-circle-check me-2'; 
                        }
                        
                        // ƒê·ªïi ch·ªØ v√† m√†u n√∫t
                        reportBtn.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i>ƒê√£ g·ª≠i b√°o c√°o';
                        reportBtn.classList.add('text-success', 'disabled'); // ƒê·ªïi sang m√†u xanh l√° cho d·ªãu m·∫Øt
                        reportBtn.style.pointerEvents = 'none'; // Kh√≥a n√∫t kh√¥ng cho b·∫•m l·∫°i
                        updateReportUI(reportBtn);
                    }
                } catch (err) { alert('G·ª≠i b√°o c√°o th·∫•t b·∫°i'); }
                finally {
                    isProcessing = false;
                    if (voteBtn) voteBtn.style.opacity = "1";
                }
                updateActionTime('report');
            });
        }

        // H√†m d√πng chung ƒë·ªÉ ƒë·ªïi icon v√† m√†u s·∫Øc
        function updateReportUI(btn) {
            btn.classList.add('text-danger', 'disabled');
            btn.style.pointerEvents = 'none'; // Kh√≥a n√∫t

            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = 'fa-solid fa-circle-exclamation me-2'; // ƒê·ªïi icon
            }

            const textSpan = btn.querySelector('span') || btn;
            if (textSpan.tagName === 'SPAN') {
                textSpan.textContent = 'ƒê√£ b√°o c√°o';
            } else {
                btn.innerHTML = '<i class="fa-solid fa-circle-exclamation me-2"></i> ƒê√£ b√°o c√°o';
            }
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>



{% endblock %}