{% extends 'travel/baseIndex.html' %}
{% load static %}

{% block title %}{{ tour.name }} - H·ªá th·ªëng ƒë·∫∑t tour chuy√™n nghi·ªáp{% endblock %}

{% block extra_css %}

<style>
    :root { 
        --primary-color: #0d6efd; 
        --orange-action: #ff5722; 
        --price-color: #e31c25; 
        --bg-light: #f8f9fa;
        --star-color: #ffc107;
    }
    
    /* Layout */
    .sync-height { display: flex; align-items: flex-start; }
    .tour-sidebar-container { position: sticky; top: 90px; height: fit-content; z-index: 10; }
    
    /* Price Card */
    .price-card { background: #fff; border-top: 5px solid var(--orange-action); border-radius: 15px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .price-box { background: #fff5f2; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .price-amount { font-size: 2.4rem; color: var(--price-color); font-weight: 800; }
    .btn-booking { background: linear-gradient(45deg, #ff5722, #ff9800); color: white; border: none; padding: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; transition: 0.3s; }
    .btn-booking:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,87,34,0.4); color: white; }

    /* Nearby Services & Tabs */
    .service-card { transition: all 0.3s ease; border: 1px solid #eee; height: 100%; background: #fff; }
    .service-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .img-service { width: 70px; height: 70px; object-fit: cover; border-radius: 10px; }
    .nav-pills .nav-link { color: #666; font-weight: 600; border-radius: 50px; padding: 8px 20px; }
    .nav-pills .nav-link.active { background-color: var(--primary-color); shadow: 0 4px 10px rgba(13,110,253,0.2); }

    /* Star Rating System */
    .star-rating-input-ltr { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 5px; }
    .star-rating-input-ltr input { display: none; }
    .star-rating-input-ltr label { font-size: 1.8rem; color: #ddd; cursor: pointer; transition: 0.2s; }
    .star-rating-input-ltr input:checked ~ label, .star-rating-input-ltr label:hover, .star-rating-input-ltr label:hover ~ label { color: var(--star-color); }

    .section-title { border-left: 4px solid var(--primary-color); padding-left: 15px; margin-bottom: 25px; font-weight: 700; color: #333; }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05); border-radius: 1rem; margin-bottom: 1.5rem; }
    .review-item { border-bottom: 1px solid #eee; padding: 20px 0; }
    .sentiment-tag { font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<main class="py-4 bg-light">
    <div class="container">
        <div class="row g-4 sync-height">
            
            <div class="col-lg-8">
                <div class="mb-4">
                    {% if tour.image_main %}
                        <img src="{{ tour.image_main.url }}" class="img-fluid rounded-4 shadow-sm w-100" style="max-height: 500px; object-fit: cover;">
                    {% else %}
                        <div class="bg-secondary text-white rounded-4 d-flex align-items-center justify-content-center" style="height: 400px;">Kh√¥ng c√≥ ·∫£nh</div>
                    {% endif %}
                </div>

                <section class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h1 class="fw-bold mb-1 text-dark">{{ tour.name }}</h1>
                        <div class="d-flex align-items-center mb-3">
                            <div class="text-warning me-2">
                                <span class="fw-bold text-dark me-1">{{ tour.average_rating|floatformat:1 }}</span>
                                {% for i in "12345" %}
                                    <i class="{% if forloop.counter <= tour.average_rating %}fa-solid{% else %}fa-regular{% endif %} fa-star small"></i>
                                {% endfor %}
                            </div>
                            <span class="text-muted border-start ps-2 small">
                                <i class="fa-solid fa-comment-dots me-1"></i>{{ tour.total_reviews }} nh·∫≠n x√©t
                            </span>
                        </div>

                        <div class="row g-3 mb-4 py-3 border-top border-bottom bg-light rounded-3">
                            <div class="col-6 col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-location-dot text-danger fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted x-small">ƒêi·ªÉm ƒë·∫øn</div>
                                        <div class="fw-bold small">{{ tour.destination.location }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-clock text-primary fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted x-small">Th·ªùi gian</div>
                                        <div class="fw-bold small">{{ tour.duration }} Ng√†y</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-calendar-check text-success fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted x-small">Kh·ªüi h√†nh</div>
                                        <div class="fw-bold small">{{ tour.start_date|date:"d/m/Y"|default:"H√†ng ng√†y" }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-tags text-info fs-5 me-2"></i>
                                    <div>
                                        <div class="text-muted x-small">Lo·∫°i h√¨nh</div>
                                        <div class="fw-bold small">{{ tour.category.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="section-title mb-3 fw-bold"><i class="fa-solid fa-circle-info me-2 text-primary"></i>Chi ti·∫øt h√†nh tr√¨nh</h5>
                        <div class="text-secondary" style="line-height: 1.8; white-space: pre-line; text-align: justify;">
                            {{ tour.details }}
                        </div>
                    </div>
                </section>

                <section class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="section-title mb-3 fw-bold"><i class="fa-solid fa-map-location-dot me-2 text-primary"></i>B·∫£n ƒë·ªì ƒëi·ªÉm t·∫≠p trung</h5>
                        <div id="map" style="height: 350px; border-radius: 15px; border: 1px solid #eee; background-color: #f8f9fa;"></div>
                        <div class="mt-3 p-3 bg-light rounded-3 d-flex align-items-start">
                            <i class="fa-solid fa-map-pin text-danger mt-1 me-2"></i>
                            <div>
                                <span class="fw-bold small d-block">ƒê·ªãa ch·ªâ t·∫≠p trung:</span>
                                <span class="text-muted small">{{ tour.meeting_point|default:tour.address_detail }}</span>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="card border-0 shadow-sm" id="reviews-section">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="fa-solid fa-comments text-primary me-2"></i>ƒê√°nh gi√° t·ª´ du kh√°ch
                            </h5>
                            <button class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                <i class="fa-solid fa-pen-to-square me-1"></i>Vi·∫øt ƒë√°nh gi√°
                            </button>
                        </div>

                        <div class="collapse mb-4" id="reviewForm">
                            <div class="p-4 bg-light rounded-4 border">
                                <h6 class="mb-3 fw-bold">
                                    <i class="fa-solid fa-paper-plane me-2 text-primary"></i>Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n
                                    {% if user.is_authenticated %}
                                        <span class="badge bg-success-subtle text-success ms-2 fw-normal"><i class="fa-solid fa-check-circle"></i> ƒê√£ x√°c minh</span>
                                    {% endif %}
                                </h6>
                                <form id="reviewFormSubmit">
                                    <input type="hidden" id="destinationId" value="{{ tour.id }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">T√™n c·ªßa b·∫°n <span class="text-danger">*</span></label>
                                            <input type="text" id="authorName" class="form-control" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."
                                                {% if user.is_authenticated %}value="{{ user.username|default:user.email }}" readonly{% endif %}
                                                minlength="2" maxlength="100" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">ƒê√°nh gi√° <span class="text-danger">*</span></label>
                                            <div class="d-flex flex-row-reverse justify-content-end gap-1 star-rating-input" id="starRatingContainer">
                                                {% for i in "54321" %}
                                                <input type="radio" class="btn-check" name="rating" id="star{{ i }}" value="{{ i }}" {% if i == "5" %}checked{% endif %}>
                                                <label for="star{{ i }}" class="text-muted cursor-pointer p-1">
                                                    <i class="fa-solid fa-star fs-5"></i>
                                                </label>
                                                {% endfor %}
                                            </div>
                                            <input type="hidden" id="ratingValue" value="5">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small fw-bold">Nh·∫≠n x√©t c·ªßa b·∫°n</label>
                                            <textarea id="comment" class="form-control" rows="4" placeholder="Tour n√†y th·∫ø n√†o? B·∫°n c√≥ h√†i l√≤ng kh√¥ng..." maxlength="2000"></textarea>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small class="text-muted x-small"><i class="fa-solid fa-robot me-1"></i>H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch c·∫£m x√∫c ƒë√°nh gi√°</small>
                                                <small class="text-muted x-small"><span id="charCount">0</span>/2000</small>
                                            </div>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="collapse" data-bs-target="#reviewForm">H·ªßy</button>
                                            <button type="submit" class="btn btn-primary btn-sm px-4" id="submitReviewBtn">G·ª≠i ƒë√°nh gi√°</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="reviewsList">
                            {% if reviews %}
                                <div class="mb-4 d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3">{{ total_reviews }} nh·∫≠n x√©t</span>
                                    <small class="text-muted">Trang {{ reviews.number }}/{{ reviews.paginator.num_pages }}</small>
                                </div>

                                {% for review in reviews %}
                                <div class="review-item border-bottom pb-4 mb-4" id="review-{{ review.id }}">
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex align-items-start">
                                            <div class="avatar-sm me-3">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 48px; height: 48px;">
                                                    {{ review.author_name|slice:":1"|upper }}
                                                </div>
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-bold text-dark">{{ review.author_name }}
                                                    {% if review.is_verified %}
                                                        <i class="fa-solid fa-circle-check text-success small ms-1" title="ƒê√£ mua tour"></i>
                                                    {% endif %}
                                                </h6>
                                                <div class="text-warning small my-1">
                                                    {% for i in "12345" %}
                                                        <i class="{% if forloop.counter <= review.rating %}fa-solid{% else %}fa-regular{% endif %} fa-star"></i>
                                                    {% endfor %}
                                                    <span class="text-muted ms-2 x-small">{{ review.created_at|date:"d/m/Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                                <li><a class="dropdown-item small report-btn" href="#"><i class="fa-solid fa-flag me-2 text-warning"></i>B√°o c√°o</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="ps-5 mt-2">
                                        <p class="text-secondary small mb-3">{{ review.comment }}</p>
                                        
                                        <div class="d-flex flex-wrap gap-2 mb-3">
                                            {% if review.positive_keywords %}
                                                {% for tag in review.positive_keywords %}
                                                <span class="badge bg-success-subtle text-success fw-normal x-small">
                                                    <i class="fa-solid fa-thumbs-up me-1"></i>{{ tag }}
                                                </span>
                                                {% endfor %}
                                            {% endif %}
                                            
                                            {% if review.negative_keywords %}
                                                {% for tag in review.negative_keywords %}
                                                <span class="badge bg-danger-subtle text-danger fw-normal x-small">
                                                    <i class="fa-solid fa-thumbs-down me-1"></i>{{ tag }}
                                                </span>
                                                {% endfor %}
                                            {% endif %}

                                            {% if review.sentiment_score %}
                                            <span class="badge {% if review.sentiment_score > 0 %}bg-info-subtle text-info{% else %}bg-secondary-subtle text-secondary{% endif %} fw-normal x-small" title="ƒêi·ªÉm c·∫£m x√∫c AI">
                                                <i class="fa-solid fa-robot me-1"></i>AI: {{ review.sentiment_score|floatformat:2 }}
                                            </span>
                                            {% endif %}
                                        </div>

                                        <div class="d-flex align-items-center gap-2">
                                            <button class="btn btn-sm btn-outline-light border text-muted x-small vote-btn" data-vote="helpful">
                                                <i class="fa-regular fa-thumbs-up me-1"></i>H·ªØu √≠ch ({{ review.helpful_count }})
                                            </button>
                                            <button class="btn btn-sm btn-outline-light border text-muted x-small vote-btn" data-vote="not_helpful">
                                                <i class="fa-regular fa-thumbs-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                {% if reviews.has_other_pages %}
                                <nav class="mt-4">
                                    <ul class="pagination pagination-sm justify-content-center">
                                        {% if reviews.has_previous %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.previous_page_number }}#reviews-section"><i class="fa-solid fa-chevron-left"></i></a></li>
                                        {% endif %}
                                        {% for num in reviews.paginator.page_range %}
                                            <li class="page-item {% if reviews.number == num %}active{% endif %}">
                                                <a class="page-link border-0 shadow-none" href="?reviews_page={{ num }}#reviews-section">{{ num }}</a>
                                            </li>
                                        {% endfor %}
                                        {% if reviews.has_next %}
                                            <li class="page-item"><a class="page-link border-0 shadow-none" href="?reviews_page={{ reviews.next_page_number }}#reviews-section"><i class="fa-solid fa-chevron-right"></i></a></li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}

                            {% else %}
                                <div class="text-center py-5 bg-light rounded-4 border-dashed">
                                    <i class="fa-solid fa-comment-dots fa-3x text-muted mb-3 opacity-25"></i>
                                    <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n!</p>
                                    <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="collapse" data-bs-target="#reviewForm">Vi·∫øt ƒë√°nh gi√° ƒë·∫ßu ti√™n</button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <style>
                    .x-small { font-size: 0.75rem; }
                    .cursor-pointer { cursor: pointer; }
                    .section-title { border-left: 4px solid #0d6efd; padding-left: 15px; }
                    
                    /* 1. Reset m√†u m·∫∑c ƒë·ªãnh cho label (b·ªè text-muted ·ªü HTML n·∫øu c·∫ßn, ho·∫∑c √©p m√†u ·ªü ƒë√¢y) */
                    .star-rating-input label { 
                        color: #ddd !important; /* M√†u x√°m khi ch∆∞a ch·ªçn */
                        transition: all 0.2s;
                    }

                    /* 2. Khi di chu·ªôt v√†o: Sao hi·ªán t·∫°i v√† c√°c sao b√™n PH·∫¢I (theo code) s·∫Ω v√†ng l√™n */
                    .star-rating-input label:hover, 
                    .star-rating-input label:hover ~ label { 
                        color: #ffc107 !important; 
                    }

                    /* 3. Khi ƒë√£ click ch·ªçn: Sao ƒë√£ ch·ªçn v√† c√°c sao b√™n PH·∫¢I (theo code) gi·ªØ m√†u v√†ng */
                    .star-rating-input input:checked ~ label { 
                        color: #ffc107 !important; 
                    }
                    
                    /* Fix l·ªói: Khi ƒëang ch·ªçn sao th·∫•p m√† di chu·ªôt v√†o sao cao h∆°n th√¨ v·∫´n ph·∫£i s√°ng */
                    .star-rating-input input:checked + label:hover,
                    .star-rating-input input:checked + label:hover ~ label {
                        color: #ffc107 !important;
                    }

                    .review-item:last-child { border-bottom: none !important; }
                    .pagination .page-link { border-radius: 8px; margin: 0 3px; color: #666; }
                    .pagination .page-item.active .page-link { background-color: #0d6efd; border-color: #0d6efd; }
                </style>
            </div>       

            <div class="col-lg-4">
                <div class="tour-sidebar-container">
                    <div class="card price-card mb-4">
                        <div class="card-body p-4 text-center">
                            <div class="price-box">
                                <small class="text-muted fw-bold">GI√Å CH·ªà T·ª™</small>
                                <div class="price-amount">{{ tour.price|floatformat:0 }} <small style="font-size: 1rem;">VND</small></div>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-booking btn-lg shadow">ƒê·∫∂T TOUR NGAY</button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-cloud-sun text-warning"></i> Th·ªùi ti·∫øt
                            </h5>
                            {% if weather_info and not weather_info.error %}
                            {% if weather_info.is_current %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">üå°Ô∏è</span>
                                <div>
                                    <p class="mb-1"><strong>Hi·ªán t·∫°i</strong></p>
                                    <p class="mb-1">Nhi·ªát ƒë·ªô: <strong>{{ weather_info.temperature }}¬∞C</strong></p>
                                    <p class="mb-0">Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">{{ weather_info.icon }}</span>
                                <div>
                                    <p class="mb-1"><strong>{{ weather_info.weather_desc }}</strong></p>
                                    <p class="mb-1">üå°Ô∏è {{ weather_info.temp_min }}¬∞C - {{ weather_info.temp_max }}¬∞C</p>
                                    <p class="mb-1">üíß M∆∞a: {{ weather_info.precipitation }} mm</p>
                                    <p class="mb-0">üí® Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Ng√†y: {{ weather_info.date }}</small>
                            {% endif %}
                            {% elif weather_info.error %}
                            <p class="text-muted">{{ weather_info.error }}</p>
                            {% else %}
                            <p class="text-muted small">
                                Nh·∫≠p ng√†y ƒëi ƒë·ªÉ xem d·ª± b√°o th·ªùi ti·∫øt.
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Kh√°ch s·∫°n g·∫ßn ƒë√≥ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-hotel text-primary"></i> Kh√°ch s·∫°n g·∫ßn ƒë√≥
                            </h5>
                            <div id="nearbyHotels">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <small class="text-muted ms-2">ƒêang t·∫£i...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Qu√°n ƒÉn g·∫ßn ƒë√≥ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fa-solid fa-utensils text-danger"></i> Qu√°n ƒÉn g·∫ßn ƒë√≥
                            </h5>
                            <div id="nearbyRestaurants">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                                    <small class="text-muted ms-2">ƒêang t·∫£i...</small>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4">
                                <i class="fa-solid fa-compass text-success me-2"></i>Tour t∆∞∆°ng t·ª±
                            </h5>
                            {% if related_tours %}
                                {% for rt in related_tours %}
                                <div class="d-flex align-items-center mb-3 pb-3 border-bottom last-child-border-0">
                                    <div class="flex-shrink-0">
                                        {% if rt.image_main %}
                                            <img src="{{ rt.image_main.url }}" class="rounded shadow-sm" style="width: 65px; height: 65px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded" style="width: 65px; height: 65px;"></div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex-grow-1 ms-3">
                                        <a href="{% url 'travel:tour_detail' rt.slug %}" class="text-decoration-none text-dark card-hover-link">
                                            <strong class="d-block mb-1 small lh-sm">{{ rt.name }}</strong>
                                        </a>
                                        <div class="small text-muted mb-1">
                                            <i class="fa-solid fa-location-dot text-danger me-1"></i> {{ rt.destination.name }}
                                        </div>
                                        <div class="text-danger fw-bold small">
                                            {{ rt.price|floatformat:0 }}ƒë
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-0">Kh√¥ng c√≥ tour t∆∞∆°ng t·ª±.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
            </div>
        </div>
    </div>
</main>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. L·∫•y t·ªça ƒë·ªô g·ªëc (x·ª≠ l√Ω d·∫•u ph·∫©y Django)
    const lat = parseFloat("{{ tour.start_latitude|default:tour.destination.latitude|stringformat:'f' }}".replace(',', '.'));
    const lon = parseFloat("{{ tour.start_longitude|default:tour.destination.longitude|stringformat:'f' }}".replace(',', '.'));

    if (!lat || !lon) return;

    // --- PH·∫¶N 1: KH·ªûI T·∫†O B·∫¢N ƒê·ªí ƒêI·ªÇM T·∫¨P TRUNG ---
    const mapElement = document.getElementById('map');
    if (mapElement) {
        // Kh·ªüi t·∫°o map
        var map = L.map('map').setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Th√™m marker ch√≠nh cho Tour
        L.marker([lat, lon]).addTo(map)
            .bindPopup("<b>ƒêi·ªÉm t·∫≠p trung:</b><br>{{ tour.meeting_point|default:tour.name }}")
            .openPopup();
        
        // Fix l·ªói b·∫£n ƒë·ªì b·ªã x√°m/l·ªách khi load trong card
        setTimeout(() => { map.invalidateSize(); }, 400);
    }

    // --- PH·∫¶N 2: H√ÄM HI·ªÜN KH√ÅCH S·∫†N V√Ä QU√ÅN ƒÇN (GI·ªÆ NGUY√äN LOGIC C·ª¶A B·∫†N) ---
    function loadNearby(type, elementId, categoryName) {
        const container = document.getElementById(elementId);
        if (!container) return;

        const searchQuery = (type === 'hotel') ? 'Kh√°ch s·∫°n' : 'Qu√°n ƒÉn';
        // Link Google Maps chu·∫©n
        const googleMapsSearchUrl = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}/@${lat},${lon},15z`;

        fetch(`/api/nearby/?lat=${lat}&lon=${lon}&type=${type}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = ''; 

                const destinationName = "{{ tour.destination.name|escapejs }}";

                let htmlHeader = `
                    <a href="${googleMapsSearchUrl}" target="_blank" class="btn btn-outline-primary w-100 mb-3 text-start shadow-sm">
                        <i class="fa-solid fa-map-location-dot me-2"></i> T√¨m ${categoryName} tr√™n Google Maps
                    </a>
                    <p class="small fw-bold mb-2 text-muted">Ho·∫∑c t√¨m tr√™n:</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        ${type === 'hotel' ? `
                            <a href="https://www.booking.com/searchresults.vi.html?ss=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Booking.com</a>
                            <a href="https://www.agoda.com/search?query=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Agoda</a>
                            <a href="https://www.traveloka.com/vi-vn/hotel/search?spec=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Traveloka</a>
                        ` : `
                            <a href="https://www.foody.vn/tim-kiem/${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">Foody</a>
                            <a href="https://shopeefood.vn/search?keyword=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">ShopeeFood</a>
                            <a href="https://grabfood.vn/search?keyword=${encodeURIComponent(destinationName)}" target="_blank" class="btn btn-sm btn-outline-secondary">GrabFood</a>
                        `}
                    </div>
                    <hr>
                `;
                container.insertAdjacentHTML('beforeend', htmlHeader);

                const items = data.results || data.places || (Array.isArray(data) ? data : []);
                items.forEach(item => {
                    const iLat = item.lat || item.latitude;
                    const iLon = item.lon || item.longitude;
                    const itemGMapUrl = `https://www.google.com/maps/search/?api=1&query=${iLat},${iLon}`;

                    const div = document.createElement('div');
                    div.className = 'list-group-item list-group-item-action mb-2 border-0 shadow-sm rounded';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="cursor:pointer" class="item-info">
                                <div class="fw-bold small">${item.name}</div>
                                <small class="text-muted">${item.address || 'ƒêang c·∫≠p nh·∫≠t...'}</small>
                            </div>
                            <a href="${itemGMapUrl}" target="_blank" class="btn btn-sm btn-light text-danger border">
                                <i class="fa-solid fa-location-dot"></i>
                            </a>
                        </div>
                    `;
                    
                    if (map) {
                        L.circleMarker([iLat, iLon], {radius: 5, color: type==='hotel'?'blue':'red'}).addTo(map)
                         .bindPopup(item.name);
                    }

                    container.appendChild(div);
                });
            })
            .catch(err => console.error("L·ªói t·∫£i " + type, err));
    }

    loadNearby('hotel', 'nearbyHotels', 'Kh√°ch s·∫°n');
    loadNearby('restaurant', 'nearbyRestaurants', 'Qu√°n ƒÉn');
});
</script>

<script>
    // 1. B·ªô ƒë·∫øm k√Ω t·ª± (C·∫≠p nh·∫≠t ID cho Tour)
    const tourCommentInput = document.getElementById('tourComment'); // ƒê·ªïi ID ƒë·ªÉ kh·ªõp HTML Tour
    const tourCharCount = document.getElementById('tourCharCount');
    if (tourCommentInput && tourCharCount) {
        tourCommentInput.addEventListener('input', () => {
            tourCharCount.textContent = tourCommentInput.value.length;
            if (tourCommentInput.value.length > 1800) {
                tourCharCount.classList.add('text-warning');
            } else {
                tourCharCount.classList.remove('text-warning');
            }
        });
    }

    // 2. X·ª≠ l√Ω Star Rating (D√πng chung logic LTR c·ªßa b·∫°n)
    const starLabels = document.querySelectorAll('.star-label-ltr');
    const ratingInput = document.getElementById('tourRatingValue'); // Hidden input l∆∞u s·ªë sao

    function updateStars(value) {
        starLabels.forEach((label, index) => {
            const starValue = index + 1;
            label.style.color = starValue <= value ? '#ffc107' : '#ddd';
            if (starValue <= value) label.classList.add('active');
            else label.classList.remove('active');
        });
    }

    // Kh·ªüi t·∫°o 4 sao m·∫∑c ƒë·ªãnh
    updateStars(4);

    starLabels.forEach((label, index) => {
        const starValue = index + 1;
        label.addEventListener('click', () => {
            ratingInput.value = starValue;
            updateStars(starValue);
        });

        label.addEventListener('mouseenter', () => {
            starLabels.forEach((l, i) => {
                l.style.color = (i + 1 <= starValue) ? '#ffc107' : '#ddd';
            });
        });
    });

    document.querySelectorAll('.star-rating-input input[name="rating"]').forEach(input => {
        input.addEventListener('change', function() {
            document.getElementById('ratingValue').value = this.value;
            console.log("ƒê√£ ch·ªçn:", this.value, "sao");
        });
    });

    // 3. Submit Review b·∫±ng AJAX
    document.getElementById('reviewFormSubmit').addEventListener('submit', function(e) {
        e.preventDefault(); // CH·∫∂N t·∫£i l·∫°i trang

        const submitBtn = document.getElementById('submitReviewBtn');
        const destinationId = document.getElementById('destinationId').value;
        const authorName = document.getElementById('authorName').value;
        const rating = document.querySelector('input[name="rating"]:checked').value; // L·∫•y gi√° tr·ªã sao ƒëang ch·ªçn
        const comment = document.getElementById('comment').value;

        const selectedRating = document.querySelector('input[name="rating"]:checked');
const ratingValue = selectedRating ? selectedRating.value : 5;

        // ƒêo·∫°n JS c·∫ßn s·ª≠a trong h√†m fetch
        const payload = {
            tour_id: document.getElementById('destinationId').value, // Ph·∫£i l√† tour_id cho kh·ªõp v·ªõi View
            author_name: document.getElementById('authorName').value,
            rating: document.getElementById('ratingValue').value,
            comment: document.getElementById('comment').value
        };

        const tourId = document.getElementById('destinationId').value;
        fetch(`/api/tour/${tourId}/review/`, { // URL ƒë√∫ng cho Tour review
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const review = data.review;
                const reviewsList = document.getElementById('reviewsList');
                
                // 1. T·∫°o chu·ªói sao HTML d·ª±a tr√™n rating
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="${i <= review.rating ? 'fa-solid' : 'fa-regular'} fa-star"></i> `;
                }

                // 2. T·∫°o giao di·ªán Review m·ªõi
                const newReviewHtml = `
                    <div class="review-item border-bottom pb-4 mb-4 animate-fade-in" style="background: #e8f5e9; padding: 15px; border-radius: 15px; border-left: 4px solid #4caf50;">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex align-items-start">
                                <div class="avatar-sm me-3">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 48px; height: 48px;">
                                        ${review.author_name.charAt(0).toUpperCase()}
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark">${review.author_name}</h6>
                                    <div class="text-warning small my-1">
                                        ${starsHtml}
                                        <span class="text-muted ms-2 x-small">V·ª´a xong</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ps-5 mt-2">
                            <p class="text-secondary small mb-3">${review.comment}</p>
                            <span class="badge bg-success fw-normal small">
                                <i class="fa-solid fa-check-circle me-1"></i>ƒê√£ g·ª≠i th√†nh c√¥ng
                            </span>
                        </div>
                    </div>
                `;

                // 3. Ch√®n v√†o ƒë·∫ßu danh s√°ch
                if (reviewsList.querySelector('.text-center.py-5')) {
                    reviewsList.innerHTML = newReviewHtml;
                } else {
                    reviewsList.insertAdjacentHTML('afterbegin', newReviewHtml);
                }

                // 4. Thu g·ªçn form v√† reset
                const bootstrapCollapse = bootstrap.Collapse.getInstance(document.getElementById('reviewForm'));
                if (bootstrapCollapse) bootstrapCollapse.hide();
                document.getElementById('reviewFormSubmit').reset();
                
                // 5. Hi·ªÉn th·ªã th√¥ng b√°o ƒë·∫πp
                showSuccessToast('C·∫£m ∆°n b·∫°n! ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng.');
            } else {
                showErrorToast(data.error || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°nh gi√°');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.');
        });
    });

    // Helper functions for toast notifications
    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show align-items-center text-white bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fa-solid fa-check-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show align-items-center text-white bg-danger border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fa-solid fa-exclamation-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }


    // --- VOTE H·ªÆU √çCH ---
    document.addEventListener('click', async function(e) {
        
        // 1. Logic Vote
        const voteBtn = e.target.closest('.vote-btn');
        if (voteBtn) {
            e.preventDefault();
            const { reviewId, vote, isTour } = voteBtn.dataset;
            
            try {
                const response = await fetch('{% url "travel:api_vote_review" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ review_id: reviewId, vote_type: vote, is_tour: isTour === "true" })
                });
                const data = await response.json();
                if (data.success) {
                    const container = voteBtn.closest('.review-item') || document.getElementById(`review-${reviewId}`);
                    if (container) {
                        const hCount = container.querySelector('.helpful-count');
                        const nhCount = container.querySelector('.not-helpful-count');
                        if (hCount) hCount.textContent = data.helpful_count;
                        if (nhCount) nhCount.textContent = data.not_helpful_count;
                    }
                    voteBtn.classList.add('text-primary', 'fw-bold');
                }
            } catch (err) { console.error('Vote failed', err); }
        }

        // 2. Logic Report
        const reportBtn = e.target.closest('.report-btn');
        if (reportBtn) {
            e.preventDefault();
            const { reviewId, isTour } = reportBtn.dataset;

            // D√πng prompt nhanh ƒë·ªÉ l·∫•y l√Ω do (ho·∫∑c m·ªü Modal n·∫øu b·∫°n ƒë√£ l√†m HTML Modal)
            const reason = prompt("L√Ω do b√°o c√°o:\n1. Spam\n2. X√∫c ph·∫°m\n3. Gi·∫£ m·∫°o\n4. Kh√°c\n(Nh·∫≠p s·ªë 1-4):");
            if (!reason) return;

            const reasonMap = { '1': 'spam', '2': 'inappropriate', '3': 'fake', '4': 'other' };
            const reasonCode = reasonMap[reason] || 'other';

            try {
                const response = await fetch('{% url "travel:api_report_review" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ 
                        review_id: reviewId, 
                        reason: reasonCode, 
                        is_tour: isTour === "true",
                        description: "B√°o c√°o nhanh t·ª´ ng∆∞·ªùi d√πng" 
                    })
                });
                const data = await response.json();
                alert(data.message);
            } catch (err) { alert('G·ª≠i b√°o c√°o th·∫•t b·∫°i'); }
        }
    });
    

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}