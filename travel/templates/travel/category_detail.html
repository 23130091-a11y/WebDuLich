{% extends "travel/base.html" %}
{% load static %}
{% load humanize %} 

{% block title %}Chi tiết danh mục - Web Du Lịch{% endblock %}

{% block extra_css %}
<style>
    /* =========================================================
       CUSTOM CSS CHO TRANG CHI TIẾT DANH MỤC
       (Áp dụng phong cách Chip và màu sắc hiện đại)
    ========================================================= */

    /* PAGE-SPECIFIC STYLES */
    .image-wrapper { height: 180px; overflow: hidden; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
    .image-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .placeholder-image { background-color: #e5e7eb; display:flex; align-items:center; justify-content:center; color:#6c757d; height: 100%; }
    .offcanvas-footer { border-top: 1px solid #dee2e6; }
    .card { border: none !important; }

    /* TOUR CARD STYLES (Cải thiện hiệu ứng nổi bật) */
    .tour-card { 
        transition: all 0.3s ease; 
        border: 1px solid #e0e0e0; /* Viền mỏng */
        background-color: #fff;
        display: flex; /* Dùng flexbox để sticky footer */
        flex-direction: column;
    }
    .tour-card .card-body {
        flex-grow: 1; /* Cho phép body mở rộng */
        display: flex;
        flex-direction: column;
    }
    .tour-card:hover { 
        box-shadow: 0 5px 20px rgba(0, 120, 255, 0.25); /* Đổ bóng mạnh hơn với màu xanh chính */
        transform: translateY(-5px); /* Nổi lên rõ ràng hơn */
        border-color: #0078ff; /* Viền xanh khi hover */
        text-decoration: none; /* Bỏ gạch chân cho thẻ <a> */
    }

    /* MÀU CHỦ ĐẠO MỚI VÀ TIÊU ĐỀ */
    /* Màu xanh chính (Thay thế indigo-600) */
    :root {
        --bs-primary: #0078ff;
    }
    .text-indigo-600, .text-primary, .btn-primary { 
        color: var(--bs-primary) !important; 
    }
    .btn-primary {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }
    .fw-bold.text-gray-800 { font-size: 28px; }
    .text-red-600 { color: #dc3545 !important; } /* Màu đỏ hiện đại hơn */
    .text-amber-500 { color: #ffc107 !important; } /* Màu vàng rating */

    /* FILTER CHIP STYLING (Phong cách hiện đại) */
    .filter-chip {
        display: inline-block;
        padding: 8px 15px;
        border-radius: 20px; /* Bo tròn mạnh */
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        
        /* Trạng thái Mặc định */
        background-color: #f5f5f5; /* Nền xám nhạt */
        color: #495057; 
        border: 1px solid #e0e0e0;
        line-height: 1; /* Fix height issue */
    }
    
    /* Trạng thái Active/Selected (Dùng màu xanh chính) */
    .filter-chip.active, .filter-chip.active.btn-primary { 
        background-color: var(--bs-primary) !important; 
        color: white !important;
        border-color: var(--bs-primary) !important;
        box-shadow: 0 1px 3px rgba(0, 120, 255, 0.4);
    }
    
    .filter-chip:hover:not(.active) {
        background-color: #e9ecef;
    }

    /* ĐIỀU CHỈNH NÚT CHÍNH CỦA DROPDOWN */
    .dropdown > .btn-outline-secondary, .dropdown > .btn-primary {
        /* Làm cho nút chính bo tròn và đẹp hơn */
        border-radius: 20px !important;
        padding: 8px 15px !important;
        font-size: 15px !important;
    }
    
    /* Rating Star Styling */
    .rating-star { cursor: pointer; }
    .rating-star.active { color: #f59e0b; }
    .rating-star-empty { color: #d1d5db; }

    /* Offcanvas Service Radio Styling */
    .filter-radio-service:hover { background-color: #f3f4f6; }
    .filter-radio-service input:checked + .form-check-label {
        color: var(--bs-primary); 
        font-weight: 600;
    }
    .service-radio:checked {
        border-color: var(--bs-primary) !important;
        background-color: var(--bs-primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="fw-bold mb-1 text-gray-800">Kết quả cho: <span class="text-indigo-600" id="mainFilterTitle">{{ category_name|default:'Biển &amp; Đảo' }}</span></h2>
    <p class="text-muted small mb-3">{{ results|length }} tour du lịch/hoạt động được tìm thấy.</p>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-flex align-items-center mb-2 me-4 flex-wrap gap-2">
            
            <div class="dropdown">
                <button class="btn btn-outline-secondary rounded-full dropdown-toggle d-flex align-items-center px-4 py-2 text-sm" type="button" id="diaDiemDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                    <i class="fa-solid fa-location-dot me-2 text-gray-500"></i> <span id="selectedDiaDiem">Địa điểm</span>
                </button>
                <div class="dropdown-menu p-3 shadow-lg border-0 rounded-xl" aria-labelledby="diaDiemDropdown" style="min-width: 250px;">
                    <p class="fw-bold mb-2">Chọn nhanh</p>
                    <div class="d-flex flex-wrap gap-2 mb-3" id="diaDiemButtons">
                        <button class="filter-chip filter-btn-location" data-value="Hà Nội">Hà Nội</button>
                        <button class="filter-chip filter-btn-location" data-value="Đà Nẵng">Đà Nẵng</button>
                        <button class="filter-chip filter-btn-location" data-value="TP. HCM">TP. HCM</button>
                        <button class="filter-chip filter-btn-location" data-value="">Tất cả</button>
                    </div>
                    <input type="text" class="form-control rounded-lg" id="locationSearchInput" placeholder="Tìm kiếm địa điểm khác...">
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-danger me-2 clear-location-filter">Xóa</button>
                        <button class="btn btn-sm btn-primary rounded-lg apply-location-filter">Áp dụng</button>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="btn btn-primary rounded-full dropdown-toggle px-4 py-2 text-sm" type="button" id="loaiHinhDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                    <span id="selectedLoaiHinhText">{{ category_name|default:'Du lịch và biển đảo' }}</span>
                </button>
                <div class="dropdown-menu p-3 shadow-lg border-0 rounded-xl" aria-labelledby="loaiHinhDropdownButton" style="min-width: 280px;">
                    <p class="dropdown-header fw-bold text-muted">Lọc theo hoạt động:</p>
                    <div class="d-flex flex-wrap gap-2 mb-2" id="tagCheckboxes">
                        {% for tag in category_tags %}
                            <button type="button"
                                    class="filter-chip tag-toggle {% if tag.slug in active_tags %}active{% endif %}"
                                    data-tag="{{ tag.slug }}">
                                {{ tag.name }}
                            </button>
                        {% endfor %}
                    </div>
                    <div class="text-end border-top pt-2">
                        <button class="btn btn-sm btn-primary" id="applyTagsBtn">Áp dụng</button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="clearTagsBtn">Xóa lọc</button>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-primary hover:bg-indigo-50 rounded-lg" href="#" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas"><i class="fa-solid fa-list-ul me-1"></i> Xem tất cả loại hình</a>
                    </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary rounded-full d-flex align-items-center px-3 py-2" type="button" id="dateDropdownButtonInline" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="fa-regular fa-calendar-days me-2"></i> <span id="selectedDateTextInline">Ngày</span>
                </button>
                <div class="dropdown-menu p-3 shadow-lg border-0 rounded-xl" aria-labelledby="dateDropdownButtonInline" style="min-width:220px;">
                    <div class="d-grid gap-2">
                        <button class="filter-chip date-preset {% if selected_date == 'today' %}active{% endif %}" data-value="today">Hôm nay</button>
                        <button class="filter-chip date-preset {% if selected_date == 'tomorrow' %}active{% endif %}" data-value="tomorrow">Ngày mai</button>
                        <div class="mt-2">
                            <label class="form-label small mb-1">Chọn ngày khác</label>
                            <input type="date" id="datePickerInputInline" class="form-control form-control-sm" />
                        </div>
                        <button class="filter-chip date-preset {% if not selected_date %}active{% endif %}" data-value="">Bỏ chọn</button>
                    </div>
                </div>
            </div>
            
            <div class="dropdown ms-2">
                <button class="btn btn-outline-primary d-flex align-items-center dropdown-toggle rounded-full" type="button" id="priceDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                    <i class="fa-solid fa-tag me-2"></i> <span id="selectedPriceTextInline">Giá</span>
                </button>
                <div class="dropdown-menu p-3 shadow-lg border-0 rounded-xl" aria-labelledby="priceDropdownButton" style="min-width:320px;">
                    <h6 class="mb-2 fw-bold text-gray-700">Lọc theo khoảng giá</h6>
                    <div class="d-flex gap-2 mb-3">
                        <div class="btn-group w-100" role="group" aria-label="Price presets">
                            <button type="button" class="btn btn-sm btn-outline-secondary price-preset" data-min="0" data-max="500000">&lt;500k</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary price-preset" data-min="500000" data-max="1000000">500k-1M</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary price-preset" data-min="1000000" data-max="10169492">1M+</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small text-muted mb-1">Tối đa: <span id="priceLabelDropdown">₫ 10.169.492</span></label>
                        <input type="range" id="priceSliderDropdown" min="0" max="10169492" value="10169492" step="50000" class="form-range">
                        <div class="mt-2 d-flex justify-content-end">
                            <button class="btn btn-sm btn-outline-danger me-2" id="clearPriceFilterDropdown">Xóa</button>
                            <button class="btn btn-sm btn-primary rounded-lg" id="applyPriceRangeDropdownView">Áp dụng</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <div>
                <button class="btn btn-outline-dark d-flex align-items-center py-2 px-3 rounded-lg shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">
                    <i class="fa-solid fa-sliders me-2"></i> Lọc chi tiết
                </button>
            </div>
            <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary d-flex align-items-center rounded-lg" type="button" id="sortDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-sort me-2"></i> Sắp xếp
                </button>
                <ul class="dropdown-menu shadow-lg border-0 rounded-xl" aria-labelledby="sortDropdownButton">
                    <li><a class="dropdown-item sort-item {% if not active_sort or active_sort == 'rating' %}active{% endif %}" href="#" data-sort="rating">Mặc định (Đánh giá)</a></li>
                    <li><a class="dropdown-item sort-item {% if active_sort == 'price_asc' %}active{% endif %}" href="#" data-sort="price_asc">Giá: tăng dần</a></li>
                    <li><a class="dropdown-item sort-item {% if active_sort == 'price_desc' %}active{% endif %}" href="#" data-sort="price_desc">Giá: giảm dần</a></li>
                    <li><a class="dropdown-item sort-item {% if active_sort == 'latest' %}active{% endif %}" href="#" data-sort="latest">Mới nhất</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12">
            <div class="row g-4" id="resultsContainer">
                {% if results %}
                    {% for a in results %}
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <a href="{% url 'tour_detail' tour_slug=a.slug %}" class="card tour-card shadow-sm border-0 rounded-xl overflow-hidden d-flex flex-column h-100">                            
                            <div class="image-wrapper">
                                {% if a.image %}
                                    <img src="{{ a.image }}" alt="{{ a.title }}" loading="lazy" onerror="this.onerror=null; this.src='{% static 'images/placeholder.jpg' %}';">
                                {% else %}
                                    <div class="placeholder-image">No Image</div>
                                {% endif %}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold fs-6 mb-1 text-truncate text-gray-900">{{ a.title }}</h5>
                                <p class="card-text text-muted small mb-2"><i class="fa-solid fa-location-dot me-1"></i> {{ a.destination }}</p>
                                
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-star text-amber-500 me-1 small"></i>
                                    <span class="small fw-bold me-2 text-gray-700">{{ a.rating|floatformat:1 }}</span>
                                    <span class="badge bg-light text-muted fw-normal text-truncate" title="{{ a.tags_text }}">{{ a.tags_text|truncatechars:35 }}</span>
                                </div>
                                
                                <p class="fw-bold text-red-600 fs-5 mt-auto mb-0" data-price="{{ a.price }}">{{ a.price|intcomma }}₫</p>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info border-0 rounded-xl shadow-sm text-center">
                            <h4 class="alert-heading">Không tìm thấy kết quả!</h4>
                            <p>Không có Tour du lịch/Hoạt động nào khớp với các tiêu chí lọc hiện tại của bạn.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end shadow-2xl" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel" style="width: 350px;">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold text-gray-800" id="filterOffcanvasLabel"><i class="fa-solid fa-filter me-2 text-indigo-600"></i> Bộ Lọc Chi Tiết</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        
        <div class="mb-4">
            <p class="fw-bold mb-2 text-gray-700">Dịch vụ/Loại hình chính</p>
            <div class="list-group rounded-lg overflow-hidden">
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Du lịch và biển đảo
                    <input class="form-check-input service-radio" type="radio" name="service" value="Du lịch và biển đảo" {% if category_name == "Du lịch và biển đảo" %}checked{% endif %}>
                </label>
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Du lịch núi & cao nguyên
                    <input class="form-check-input service-radio" type="radio" name="service" value="Du lịch núi & cao nguyên" {% if category_name == "Du lịch núi & cao nguyên" %}checked{% endif %}>
                </label>
                 <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Văn hóa - lịch sử
                    <input class="form-check-input service-radio" type="radio" name="service" value="Văn hóa - lịch sử" {% if category_name == "Văn hóa - lịch sử" %}checked{% endif %}>
                </label>
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Du lịch sinh thái
                    <input class="form-check-input service-radio" type="radio" name="service" value="Du lịch sinh thái" {% if category_name == "Du lịch sinh thái" %}checked{% endif %}>
                </label>
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Ẩm thực - chợ đêm
                    <input class="form-check-input service-radio" type="radio" name="service" value="Ẩm thực - chợ đêm" {% if category_name == "Ẩm thực - chợ đêm" %}checked{% endif %}>
                </label>
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Lễ hội - sự kiện
                    <input class="form-check-input service-radio" type="radio" name="service" value="Lễ hội - sự kiện" {% if category_name == "Lễ hội - sự kiện" %}checked{% endif %}>
                </label>
                <label class="list-group-item filter-radio-service d-flex justify-content-between align-items-center">
                    Nghỉ dưỡng - thư giãn
                    <input class="form-check-input service-radio" type="radio" name="service" value="Nghỉ dưỡng - thư giãn" {% if category_name == "Nghỉ dưỡng - thư giãn" %}checked{% endif %}>
                </label>
            </div>
        </div>

        <hr class="my-3">

        <div class="mb-4">
            <p class="fw-bold mb-2 text-gray-700">Điểm đến phổ biến</p>
            <div class="d-flex flex-wrap gap-2" id="offcanvasDiaDiemButtons">
                <button class="filter-chip filter-btn-location-offcanvas" data-value="TP. HCM">TP. HCM</button>
                <button class="filter-chip filter-btn-location-offcanvas" data-value="Hà Nội">Hà Nội</button>
                <button class="filter-chip filter-btn-location-offcanvas" data-value="Đà Nẵng">Đà Nẵng</button>
                <button class="filter-chip filter-btn-location-offcanvas" data-value="">Tất cả</button>
            </div>
        </div>
        
        <hr class="my-3">

        <div class="mb-4">
            <p class="fw-bold mb-2 text-gray-700">Ngày tham gia</p>
            <div class="d-grid gap-2" id="offcanvasNgayButtons">
                <button class="filter-chip filter-btn-ngay-offcanvas" data-value="today">Hôm nay</button>
                <button class="filter-chip filter-btn-ngay-offcanvas" data-value="tomorrow">Ngày mai</button>
                <div class="mt-2">
                    <label class="form-label small mb-1">Chọn ngày</label>
                    <input type="date" id="offcanvasDatePicker" class="form-control form-control-sm" />
                </div>
                <button class="filter-chip filter-btn-ngay-offcanvas" data-value="">Bỏ chọn</button>
            </div>
        </div>

        <hr class="my-3">
        
        <div class="mb-4">
            <p class="fw-bold mb-2 text-gray-700">Khoảng giá</p>
            <p class="small text-muted" id="priceRangeDisplayOffcanvas">₫ 10.169.492</p>
            <div class="mb-2">
                <input type="range" class="form-range" id="priceSliderOffcanvas" min="0" max="10169492" value="10169492" step="50000">
            </div>
        </div>
        
        <hr class="my-3">
        
        <div class="mb-4">
            <p class="fw-bold mb-2 text-gray-700">Đánh giá tối thiểu</p>
            <div class="d-flex gap-1 fs-5" id="ratingStarsOffcanvas">
                <i class="fa-solid fa-star rating-star" data-rating="1"></i>
                <i class="fa-solid fa-star rating-star" data-rating="2"></i>
                <i class="fa-solid fa-star rating-star" data-rating="3"></i>
                <i class="fa-solid fa-star rating-star" data-rating="4"></i>
                <i class="fa-solid fa-star rating-star" data-rating="5"></i>
            </div>
            <input type="hidden" id="minRatingOffcanvas" value="4">
        </div>

    </div>
    <div class="offcanvas-footer p-3 d-flex justify-content-between">
        <button class="btn btn-outline-danger rounded-lg" id="clearOffcanvasFilters">Xóa bộ lọc</button>
        <button class="btn btn-primary rounded-lg text-white" id="applyOffcanvasFilters">Xem kết quả</button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const MAX_PRICE = 10169492;
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 });

    // Helper: Formats price for display
    function formatPriceDisplay(price) {
        price = Number(price);
        if (price >= MAX_PRICE) return 'Không giới hạn';
        return formatter.format(price);
    }

    // Helper: set or remove query param and navigate
    function setQueryParamAndReload(key, value) {
        const url = new URL(window.location.href);
        // Xử lý giá trị rỗng/null/undefined
        if (value === null || value === '' || value === undefined) {
            url.searchParams.delete(key);
        } else {
            url.searchParams.set(key, value);
        }
        // Xóa các tham số phân trang
        if (url.searchParams.has('page')) url.searchParams.delete('page');
        window.location.href = url.toString();
    }
    
    // Helper: Lấy URL hiện tại để thao tác
    function getCurrentURL() {
        return new URL(window.location.href);
    }
    
    // Cập nhật tên hiển thị của Loại hình chính (Dropdown)
    function updateLoaiHinhLabel() {
        const count = document.querySelectorAll('.tag-toggle.active').length;
        const labelEl = document.getElementById('selectedLoaiHinhText');
        if (labelEl) {
            if (count === 0) {
                // Nếu không có tag nào được chọn, hiển thị tên category chính
                labelEl.textContent = '{{ category_name|default:"Du lịch và biển đảo" }}';
            }
            else {
                labelEl.textContent = `${count} hoạt động`;
            }
        }
    }


    // --- INITIALIZATION & DROPDOWN LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        const params = getCurrentURL().searchParams;
        
        // --- 1. LOCATION FILTER LOGIC ---
        
        // Helper để đồng bộ trạng thái active cho các nút địa điểm
        function syncLocationButtons(locationValue) {
            document.querySelectorAll('.filter-btn-location, .filter-btn-location-offcanvas').forEach(btn => {
                const isActive = (btn.dataset.value || '') === locationValue;
                btn.classList.toggle('active', isActive);
            });
            
            const diaDiemText = document.getElementById('selectedDiaDiem');
            if (diaDiemText) {
                 diaDiemText.textContent = locationValue || 'Địa điểm';
            }
        }
        
        // On Load: Khởi tạo trạng thái địa điểm
        const initialDest = params.get('destination') || '';
        syncLocationButtons(initialDest);

        // Location Apply button listener (Dropdown)
        document.querySelector('.apply-location-filter').addEventListener('click', function() {
            const selectedBtn = document.querySelector('#diaDiemButtons .filter-btn-location.active');
            const manualInput = document.getElementById('locationSearchInput').value.trim();
            
            let destination = manualInput;
            if (selectedBtn && !manualInput) { // Ưu tiên nút bấm nếu không nhập tay
                 destination = selectedBtn.dataset.value;
            } else if (selectedBtn && manualInput) {
                 // Nếu người dùng chọn nút và nhập tay, ưu tiên nhập tay
            } else if (!selectedBtn && !manualInput) {
                 destination = '';
            }
            
            setQueryParamAndReload('destination', destination);
        });
        
        // Location Clear button listener (Dropdown)
        document.querySelector('.clear-location-filter').addEventListener('click', function() {
            document.getElementById('locationSearchInput').value = '';
            setQueryParamAndReload('destination', '');
        });

        // Click trên nút địa điểm sẽ tự động set giá trị vào input
        document.querySelectorAll('.filter-btn-location').forEach(btn => {
            btn.addEventListener('click', function() {
                // Nếu là nút 'Tất cả' thì xóa input
                const value = this.dataset.value === '' ? '' : this.dataset.value;
                document.getElementById('locationSearchInput').value = value;
                // Tuy nhiên không reload ngay, chờ nhấn "Áp dụng"
            });
        });


        // --- 2. DATE FILTER LOGIC (Dropdown) ---
        
        // Helper: Hàm xử lý click nút preset/input ngày
        function setDateParam(val) {
            setQueryParamAndReload('date', val);
        }

        // Click Preset Buttons
        document.querySelectorAll('.date-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                setDateParam(this.dataset.value);
            });
        });
        
        // Input Date Picker (Dropdown)
        document.getElementById('datePickerInputInline').addEventListener('change', function() {
            if (this.value) setDateParam(this.value);
        });
        
        // On Load: Đồng bộ input date picker
        const dateParam = params.get('date');
        if (dateParam && dateParam !== 'today' && dateParam !== 'tomorrow') {
            document.getElementById('datePickerInputInline').value = dateParam;
        }


        // --- 3. PRICE SLIDER DROPDOWN LOGIC ---
        const sliderDropdown = document.getElementById('priceSliderDropdown');
        const labelDropdown = document.getElementById('priceLabelDropdown');
        const applyViewBtnDropdown = document.getElementById('applyPriceRangeDropdownView');
        const clearPriceFilterDropdown = document.getElementById('clearPriceFilterDropdown');

        function syncDropdownPriceLabel() {
            if (sliderDropdown && labelDropdown) {
                const maxVal = Number(sliderDropdown.value);
                labelDropdown.textContent = formatPriceDisplay(maxVal);
            }
        }

        if (sliderDropdown) {
            sliderDropdown.addEventListener('input', syncDropdownPriceLabel);
            const priceMaxParam = params.get('price_max');
            if (priceMaxParam) sliderDropdown.value = priceMaxParam;
            syncDropdownPriceLabel();
        }

        if (applyViewBtnDropdown) applyViewBtnDropdown.addEventListener('click', function() { 
            let maxVal = sliderDropdown ? sliderDropdown.value : '';
            if (Number(maxVal) >= MAX_PRICE) maxVal = ''; // Clear max filter if full range selected
            // Giữ price_min hiện tại
            const minVal = params.get('price_min') || '';
            
            const url = getCurrentURL();
            url.searchParams.delete('price_max');
            url.searchParams.delete('price_min');
            if (minVal) url.searchParams.set('price_min', minVal);
            if (maxVal) url.searchParams.set('price_max', maxVal);
            
            if (url.searchParams.has('page')) url.searchParams.delete('page');
            window.location.href = url.toString();
        });
        
        clearPriceFilterDropdown.addEventListener('click', function() {
             const url = getCurrentURL();
             url.searchParams.delete('price_min');
             url.searchParams.delete('price_max');
             if (url.searchParams.has('page')) url.searchParams.delete('page');
             window.location.href = url.toString();
        });


        // Price preset buttons logic
        document.querySelectorAll('.price-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const min = this.dataset.min || '';
                const max = this.dataset.max || '';
                
                // Update slider value to reflect selected preset max
                if (sliderDropdown) sliderDropdown.value = max || MAX_PRICE;
                syncDropdownPriceLabel(); // Update dropdown label

                const url = getCurrentURL();
                
                url.searchParams.delete('price_min');
                url.searchParams.delete('price_max');
                
                if (min) url.searchParams.set('price_min', min);
                if (max && Number(max) < MAX_PRICE) url.searchParams.set('price_max', max);
                
                if (url.searchParams.has('page')) url.searchParams.delete('page');
                window.location.href = url.toString();
            });
        });
        
        // --- 4. SORT LOGIC ---
        document.querySelectorAll('.sort-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const sortValue = this.dataset.sort === 'rating' ? '' : this.dataset.sort;
                setQueryParamAndReload('sort', sortValue);
            });
        });
        
        // --- 5. TAGS/HOẠT ĐỘNG LOGIC (Dropdown) ---
        
        // Toggle Tag Chip
        document.querySelectorAll('.tag-toggle').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault(); // Ngăn chặn sự kiện dropup
                this.classList.toggle('active');
                updateLoaiHinhLabel();
            });
        });

        // Apply Tags
        document.getElementById('applyTagsBtn') && document.getElementById('applyTagsBtn').addEventListener('click', function() {
            const selected = Array.from(document.querySelectorAll('.tag-toggle.active')).map(b => b.dataset.tag).filter(Boolean);
            const url = getCurrentURL();
            // remove existing tag params
            url.searchParams.delete('tag');
            selected.forEach(t => url.searchParams.append('tag', t));
            if (url.searchParams.has('page')) url.searchParams.delete('page');
            window.location.href = url.toString();
        });
        
        // Clear Tags
        document.getElementById('clearTagsBtn') && document.getElementById('clearTagsBtn').addEventListener('click', function() {
            const url = getCurrentURL();
            url.searchParams.delete('tag');
            if (url.searchParams.has('page')) url.searchParams.delete('page');
            window.location.href = url.toString();
        });
        
        updateLoaiHinhLabel(); // Update label on load based on URL tags
    });


    // --- OFFCANVAS SPECIFIC LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        const params = getCurrentURL().searchParams;
        const sliderOffcanvas = document.getElementById('priceSliderOffcanvas');
        const displayOffcanvas = document.getElementById('priceRangeDisplayOffcanvas');
        const applyOffcanvasBtn = document.getElementById('applyOffcanvasFilters');
        const clearOffcanvasBtn = document.getElementById('clearOffcanvasFilters');
        const offcanvasDatePicker = document.getElementById('offcanvasDatePicker');
        const ratingStars = document.getElementById('ratingStarsOffcanvas');
        const minRatingHidden = document.getElementById('minRatingOffcanvas');
        
        // --- OFFCANVAS: PRICE SLIDER ---
        function syncOffcanvasPriceLabel() {
            if (sliderOffcanvas && displayOffcanvas) {
                const maxVal = Number(sliderOffcanvas.value);
                displayOffcanvas.textContent = formatPriceDisplay(maxVal);
            }
        }

        if (sliderOffcanvas) {
            sliderOffcanvas.addEventListener('input', syncOffcanvasPriceLabel);
            
            // Sync initial value from URL
            const priceMaxParam = params.get('price_max');
            if (priceMaxParam) sliderOffcanvas.value = priceMaxParam;
            else sliderOffcanvas.value = MAX_PRICE; // Set max value if no filter
            
            syncOffcanvasPriceLabel();
        }

        // --- OFFCANVAS: RATING STARS ---
        function syncRatingStars(minRating) {
            ratingStars.querySelectorAll('.rating-star').forEach(star => {
                const rating = Number(star.dataset.rating);
                if (rating <= minRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            minRatingHidden.value = minRating;
        }

        ratingStars.querySelectorAll('.rating-star').forEach(star => {
            star.addEventListener('click', function() {
                const selectedRating = Number(this.dataset.rating);
                syncRatingStars(selectedRating);
            });
        });
        
        // Sync initial rating from URL
        // Cần thêm filter cho rating vào views.py (ví dụ: ?rating_min=4)
        const ratingMinParam = params.get('rating_min') || 0; // Giả sử rating_min là tham số lọc
        syncRatingStars(Number(ratingMinParam) || 4); // Default to 4 if no param

        // --- OFFCANVAS: DATE & LOCATION SYNC ---
        // Date: Sync date picker input (Offcanvas)
        if (dateParam && dateParam !== 'today' && dateParam !== 'tomorrow' && offcanvasDatePicker) {
            offcanvasDatePicker.value = dateParam;
        }
        // Location: Already synced by syncLocationButtons
        
        // --- OFFCANVAS: MAIN FILTER LOGIC ---
        
        // Apply Filters button
        applyOffcanvasBtn.addEventListener('click', function() {
            const url = getCurrentURL();
            
            // 1. Dịch vụ/Loại hình chính
            const selectedService = document.querySelector('.service-radio:checked');
            if (selectedService) {
                // Tham số category trong views.py cần là SLUG của tên dịch vụ
                const serviceValue = selectedService.value; // Dịch vụ chưa chuẩn hóa
                url.searchParams.set('category', serviceValue); // Django views.py sẽ tự normalize
            }
            
            // 2. Địa điểm (Lấy từ nút active)
            const selectedLocationBtn = document.querySelector('#offcanvasDiaDiemButtons .filter-btn-location-offcanvas.active');
            const destValue = selectedLocationBtn ? (selectedLocationBtn.dataset.value || '') : '';
            url.searchParams.delete('destination');
            if (destValue) url.searchParams.set('destination', destValue);
            
            // 3. Ngày (Ưu tiên input date, sau đó đến nút preset)
            let dateValue = '';
            if (offcanvasDatePicker && offcanvasDatePicker.value) {
                dateValue = offcanvasDatePicker.value;
            } else {
                const selectedDateBtn = document.querySelector('#offcanvasNgayButtons .filter-btn-ngay-offcanvas.active');
                dateValue = selectedDateBtn ? (selectedDateBtn.dataset.value || '') : '';
            }
            url.searchParams.delete('date');
            if (dateValue) url.searchParams.set('date', dateValue);
            
            // 4. Giá (Max Price only)
            const maxVal = sliderOffcanvas ? sliderOffcanvas.value : '';
            url.searchParams.delete('price_max');
            // Cần giữ price_min nếu có
            const minVal = params.get('price_min') || '';
            url.searchParams.delete('price_min');
            if (minVal) url.searchParams.set('price_min', minVal);
            if (maxVal && Number(maxVal) < MAX_PRICE) url.searchParams.set('price_max', maxVal);
            
            // 5. Đánh giá tối thiểu
            const minRating = minRatingHidden ? minRatingHidden.value : '';
            url.searchParams.delete('rating_min');
            if (minRating && Number(minRating) > 0) url.searchParams.set('rating_min', minRating);
            
            // Reload
            if (url.searchParams.has('page')) url.searchParams.delete('page');
            window.location.href = url.toString();
        });
        
        // Clear Filters button
        clearOffcanvasBtn.addEventListener('click', function() {
            // Xóa tất cả các tham số lọc: category, destination, date, price_min, price_max, rating_min, tag
            const url = getCurrentURL();
            url.searchParams.delete('category');
            url.searchParams.delete('destination');
            url.searchParams.delete('date');
            url.searchParams.delete('price_min');
            url.searchParams.delete('price_max');
            url.searchParams.delete('rating_min');
            url.searchParams.delete('tag');
            
            if (url.searchParams.has('page')) url.searchParams.delete('page');
            window.location.href = url.toString();
        });
        
        // --- OFFCANVAS: DATE PRESET LOGIC ---
        document.querySelectorAll('.filter-btn-ngay-offcanvas').forEach(btn => {
            btn.addEventListener('click', function() {
                // Toggble active state
                document.querySelectorAll('.filter-btn-ngay-offcanvas').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // Clear input date
                offcanvasDatePicker.value = ''; 
            });
        });
        offcanvasDatePicker.addEventListener('change', function() {
            // Clear preset buttons when manual date is set
            document.querySelectorAll('.filter-btn-ngay-offcanvas').forEach(b => b.classList.remove('active'));
        });
        
        // --- OFFCANVAS: SERVICE RADIO LOGIC ---
        document.querySelectorAll('.service-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                // Thao tác này chỉ chọn filter, không reload ngay. Chờ nút Áp dụng.
            });
        });
        
    });
</script>
{% endblock %}