<!DOCTYPE html>
<html lang="vi">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>{{ destination.name }} - Web Du L·ªãch</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Leaflet CSS cho b·∫£n ƒë·ªì -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
<header class="header sticky-top bg-white shadow-sm">
    <div class="container">
        <nav class="navbar navbar-expand-lg px-4 py-2">
            <a class="navbar-brand fw-bold text-primary" href="{% url 'travel:home' %}">
                <i class="fa-solid fa-plane-departure me-2"></i>Du L·ªãch Vi·ªát
            </a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'travel:home' %}">
                        <i class="fa-solid fa-home me-1"></i>Trang ch·ªß
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'travel:search' %}">
                        <i class="fa-solid fa-search me-1"></i>T√¨m ki·∫øm
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:history.back()">
                        <i class="fa-solid fa-arrow-left me-1"></i>Quay l·∫°i
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</header>

<main class="py-4">
    <div class="container">
        <!-- Breadcrumb v√† n√∫t h√†nh ƒë·ªông -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'travel:home' %}"><i class="fa-solid fa-home"></i> Trang ch·ªß</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'travel:search' %}">T√¨m ki·∫øm</a></li>
                    <li class="breadcrumb-item active">{{ destination.name }}</li>
                </ol>
            </nav>
            <div class="action-buttons">
                <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">
                    <i class="fa-solid fa-arrow-left me-1"></i>Quay l·∫°i
                </button>
                <a href="{% url 'travel:home' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-home me-1"></i>Trang ch·ªß
                </a>
            </div>
        </div>

        <div class="row">
            <!-- C·ªôt tr√°i: Th√¥ng tin ch√≠nh -->
            <div class="col-lg-8">
                <!-- H√¨nh ·∫£nh -->
                <div class="mb-4">
                    {% if destination.image %}
                    <img src="{{ destination.image.url }}" class="img-fluid rounded" alt="{{ destination.name }}">
                    {% else %}
                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" 
                         style="height: 400px;">
                        <i class="fa-solid fa-image fa-5x"></i>
                    </div>
                    {% endif %}
                </div>

                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h1 class="card-title">{{ destination.name }}</h1>
                        <p class="text-muted">
                            <i class="fa-solid fa-location-dot"></i> {{ destination.location }}
                            {% if destination.address %}
                            - {{ destination.address }}
                            {% endif %}
                        </p>
                        <span class="badge bg-info">{{ destination.travel_type }}</span>
                        
                        {% if recommendation %}
                        <div class="mt-3">
                            <div class="d-flex align-items-center">
                                <span class="text-warning fs-4">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= recommendation.avg_rating %}
                                        ‚òÖ
                                        {% else %}
                                        ‚òÜ
                                        {% endif %}
                                    {% endfor %}
                                </span>
                                <span class="ms-2">
                                    {{ recommendation.avg_rating|floatformat:1 }}/5.0
                                    ({{ recommendation.total_reviews }} ƒë√°nh gi√°)
                                </span>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-success">
                                    ƒêi·ªÉm g·ª£i √Ω: {{ recommendation.overall_score|floatformat:0 }}/100
                                </span>
                                <span class="badge bg-primary">
                                    {{ recommendation.positive_review_ratio|floatformat:0 }}% ƒë√°nh gi√° t√≠ch c·ª±c
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <hr>
                        
                        <h5>M√¥ t·∫£</h5>
                        <p>{{ destination.description|default:"Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt." }}</p>
                        
                        {% if destination.avg_price %}
                        <div class="alert alert-warning mt-3">
                            <h5 class="alert-heading">
                                <i class="fa-solid fa-tag"></i> Gi√° tham kh·∫£o trung b√¨nh
                            </h5>
                            <p class="fs-4 fw-bold mb-1">{{ destination.avg_price|floatformat:0 }} VNƒê</p>
                            <small class="text-muted">
                                *ƒê√¢y l√† gi√° trung b√¨nh tham kh·∫£o. Vui l√≤ng li√™n h·ªá nh√† cung c·∫•p ƒë·ªÉ c√≥ gi√° ch√≠nh x√°c.
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-3">
                            <a href="#reviews-section" class="btn btn-outline-primary">
                                <i class="fa-solid fa-comments me-2"></i>Xem {{ reviews|length }} ƒë√°nh gi√°
                            </a>
                            <button class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                <i class="fa-solid fa-pen me-2"></i>Vi·∫øt ƒë√°nh gi√°
                            </button>
                            <button class="btn btn-outline-info" onclick="window.print()">
                                <i class="fa-solid fa-print me-2"></i>In th√¥ng tin
                            </button>
                        </div>
                    </div>
                </div>

                <!-- B·∫£n ƒë·ªì -->
                {% if destination.latitude and destination.longitude %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">V·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</h5>
                        <div id="map" style="height: 300px; border-radius: 8px;"></div>
                        {% if distance %}
                        <p class="mt-2 text-muted">
                            <i class="fa-solid fa-route"></i> 
                            Kho·∫£ng c√°ch t·ª´ v·ªã tr√≠ c·ªßa b·∫°n: <strong>{{ distance }} km</strong>
                        </p>
                        {% endif %}
                        {% if route_info %}
                        <p class="mt-2 text-success">
                            <i class="fa-solid fa-check-circle"></i> 
                            ƒê∆∞·ªùng ƒëi ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n v√† hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- ƒê√°nh gi√° -->
                <div class="card" id="reviews-section">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="fa-solid fa-comments text-primary me-2"></i>ƒê√°nh gi√° t·ª´ du kh√°ch
                            </h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                <i class="fa-solid fa-plus me-1"></i>Vi·∫øt ƒë√°nh gi√°
                            </button>
                        </div>
                        
                        <!-- Form g·ª≠i ƒë√°nh gi√° (collapse) -->
                        <div class="collapse mb-4" id="reviewForm">
                            <div class="p-4 bg-light rounded border">
                                <h6 class="mb-3">
                                    <i class="fa-solid fa-pen-to-square me-2"></i>Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n
                                </h6>
                                <form id="reviewFormSubmit">
                                    <input type="hidden" id="destinationId" value="{{ destination.id }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">T√™n c·ªßa b·∫°n</label>
                                            <input type="text" id="authorName" class="form-control" placeholder="Nh·∫≠p t√™n..." required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">ƒê√°nh gi√°</label>
                                            <select id="rating" class="form-select">
                                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Tuy·ªát v·ªùi</option>
                                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê T·ªët</option>
                                                <option value="3" selected>‚≠ê‚≠ê‚≠ê B√¨nh th∆∞·ªùng</option>
                                                <option value="2">‚≠ê‚≠ê T·ªá</option>
                                                <option value="1">‚≠ê R·∫•t t·ªá</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-bold">Nh·∫≠n x√©t</label>
                                            <textarea id="comment" class="form-control" rows="4" 
                                                      placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ ƒë·ªãa ƒëi·ªÉm n√†y..." required></textarea>
                                            <small class="text-muted">AI s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch c·∫£m x√∫c v√† tr√≠ch xu·∫•t t·ª´ kh√≥a t·ª´ nh·∫≠n x√©t c·ªßa b·∫°n</small>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fa-solid fa-paper-plane me-2"></i>G·ª≠i ƒë√°nh gi√°
                                            </button>
                                            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                                H·ªßy
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Danh s√°ch ƒë√°nh gi√° -->
                        <div id="reviewsList">
                            {% if reviews %}
                                <div class="mb-3">
                                    <span class="badge bg-primary">{{ reviews|length }} ƒë√°nh gi√°</span>
                                </div>
                                {% for review in reviews %}
                                <div class="review-item border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong class="text-primary">
                                                <i class="fa-solid fa-user-circle me-1"></i>{{ review.author_name }}
                                            </strong>
                                            <div class="text-warning my-1">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                                {% endfor %}
                                                <span class="text-muted small ms-2">({{ review.rating }}/5)</span>
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fa-solid fa-clock me-1"></i>{{ review.created_at|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                    <p class="mb-2 mt-2">{{ review.comment }}</p>
                                    <div class="keywords">
                                        {% if review.positive_keywords %}
                                        <span class="badge bg-success-subtle text-success me-1">
                                            <i class="fa-solid fa-thumbs-up me-1"></i>
                                            {{ review.positive_keywords|join:", " }}
                                        </span>
                                        {% endif %}
                                        {% if review.negative_keywords %}
                                        <span class="badge bg-danger-subtle text-danger">
                                            <i class="fa-solid fa-thumbs-down me-1"></i>
                                            {{ review.negative_keywords|join:", " }}
                                        </span>
                                        {% endif %}
                                        {% if review.sentiment_score %}
                                        <span class="badge bg-info-subtle text-info ms-1">
                                            AI Score: {{ review.sentiment_score|floatformat:2 }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fa-solid fa-comment-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª tr·∫£i nghi·ªám!</p>
                                    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                        <i class="fa-solid fa-plus me-1"></i>Vi·∫øt ƒë√°nh gi√° ƒë·∫ßu ti√™n
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i: Th√¥ng tin b·ªï sung -->
            <div class="col-lg-4">
                <!-- Th√¥ng tin nhanh -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Th√¥ng tin nhanh</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fa-solid fa-map-marker-alt text-primary"></i>
                                <strong>V·ªã tr√≠:</strong> {{ destination.location }}
                            </li>
                            <li class="mb-2">
                                <i class="fa-solid fa-tag text-primary"></i>
                                <strong>Lo·∫°i h√¨nh:</strong> {{ destination.travel_type }}
                            </li>
                            {% if destination.avg_price %}
                            <li class="mb-2">
                                <i class="fa-solid fa-money-bill text-primary"></i>
                                <strong>Gi√° TB:</strong> {{ destination.avg_price|floatformat:0 }} VNƒê
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <!-- Th√¥ng tin ƒë∆∞·ªùng ƒëi -->
                {% if route_info %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fa-solid fa-route text-primary"></i> ƒê∆∞·ªùng ƒëi
                        </h5>
                        <p class="mb-2">
                            <strong>T·ª´:</strong> {{ from_location }}
                        </p>
                        <p class="mb-2">
                            <i class="fa-solid fa-road"></i> Kho·∫£ng c√°ch: <strong>{{ route_info.distance_km }} km</strong>
                        </p>
                        <p class="mb-2">
                            <i class="fa-solid fa-clock"></i> Th·ªùi gian: <strong>{{ route_info.duration_hours }} gi·ªù</strong>
                        </p>
                        {% if route_info.note %}
                        <small class="text-muted">{{ route_info.note }}</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Th·ªùi ti·∫øt -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fa-solid fa-cloud-sun text-warning"></i> Th·ªùi ti·∫øt
                        </h5>
                        {% if weather_info and not weather_info.error %}
                            {% if weather_info.is_current %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">üå°Ô∏è</span>
                                <div>
                                    <p class="mb-1"><strong>Hi·ªán t·∫°i</strong></p>
                                    <p class="mb-1">Nhi·ªát ƒë·ªô: <strong>{{ weather_info.temperature }}¬∞C</strong></p>
                                    <p class="mb-0">Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center">
                                <span class="fs-1 me-3">{{ weather_info.icon }}</span>
                                <div>
                                    <p class="mb-1"><strong>{{ weather_info.weather_desc }}</strong></p>
                                    <p class="mb-1">üå°Ô∏è {{ weather_info.temp_min }}¬∞C - {{ weather_info.temp_max }}¬∞C</p>
                                    <p class="mb-1">üíß M∆∞a: {{ weather_info.precipitation }} mm</p>
                                    <p class="mb-0">üí® Gi√≥: {{ weather_info.windspeed }} km/h</p>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Ng√†y: {{ weather_info.date }}</small>
                            {% endif %}
                        {% elif weather_info.error %}
                            <p class="text-muted">{{ weather_info.error }}</p>
                        {% else %}
                            <p class="text-muted small">
                                Nh·∫≠p ng√†y ƒëi ƒë·ªÉ xem d·ª± b√°o th·ªùi ti·∫øt.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- G·ª£i √Ω li√™n quan -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ƒê·ªãa ƒëi·ªÉm t∆∞∆°ng t·ª±</h5>
                        <p class="text-muted small">C√°c ƒë·ªãa ƒëi·ªÉm kh√°c b·∫°n c√≥ th·ªÉ quan t√¢m...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="footer mt-5">
    <div class="footer-container">
        <div class="footer-col">
            <h3>H·ªó tr·ª£</h3>
            <ul>
                <li>Ch√≠nh s√°ch kh√°ch h√†ng</li>
            </ul>
        </div>
        <div class="footer-col">
            <h3>V·ªÅ ch√∫ng t√¥i</h3>
            <ul>
                <li>Gi·ªõi thi·ªáu</li>
            </ul>
        </div>
    </div>
</footer>

<!-- Script b·∫£n ƒë·ªì -->
{% if destination.latitude and destination.longitude %}
<script>
    const map = L.map('map').setView([{{ destination.latitude }}, {{ destination.longitude }}], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Marker ƒëi·ªÉm ƒë·∫øn
    L.marker([{{ destination.latitude }}, {{ destination.longitude }}])
        .addTo(map)
        .bindPopup('<b>{{ destination.name }}</b><br>{{ destination.location }}')
        .openPopup();
    
    // V·∫Ω ƒë∆∞·ªùng ƒëi n·∫øu c√≥
    {% if route_info and from_coords %}
    // Marker ƒëi·ªÉm xu·∫•t ph√°t
    L.marker([{{ from_coords.lat }}, {{ from_coords.lon }}])
        .addTo(map)
        .bindPopup('<b>ƒêi·ªÉm xu·∫•t ph√°t</b><br>{{ from_location }}');
    
    // V·∫Ω ƒë∆∞·ªùng ƒëi
    {% if route_info.geometry %}
    const routeCoords = {{ route_info.geometry|safe }};
    const routeLine = routeCoords.map(coord => [coord[1], coord[0]]);
    L.polyline(routeLine, {color: 'blue', weight: 4, opacity: 0.7}).addTo(map);
    
    // Fit bounds ƒë·ªÉ hi·ªÉn th·ªã c·∫£ 2 ƒëi·ªÉm
    const bounds = L.latLngBounds([
        [{{ from_coords.lat }}, {{ from_coords.lon }}],
        [{{ destination.latitude }}, {{ destination.longitude }}]
    ]);
    map.fitBounds(bounds, {padding: [50, 50]});
    {% endif %}
    {% endif %}
</script>
{% endif %}

<!-- Script g·ª≠i ƒë√°nh gi√° -->
<script>
document.getElementById('reviewFormSubmit').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i...';
    
    const formData = new FormData();
    formData.append('destination_id', document.getElementById('destinationId').value);
    formData.append('author_name', document.getElementById('authorName').value || 'Anonymous');
    formData.append('rating', document.getElementById('rating').value);
    formData.append('comment', document.getElementById('comment').value);
    
    try {
        const response = await fetch('{% url "travel:api_submit_review" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fa-solid fa-check-circle me-2"></i>${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('reviewForm').insertAdjacentElement('beforebegin', alertDiv);
            
            // Reload sau 1.5 gi√¢y
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('L·ªói: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (err) {
        alert('L·ªói k·∫øt n·ªëi: ' + err);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Smooth scroll ƒë·∫øn ph·∫ßn ƒë√°nh gi√°
document.querySelectorAll('a[href="#reviews-section"]').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('reviews-section').scrollIntoView({ behavior: 'smooth' });
    });
});
</script>

</body>
</html>
